<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Ce MƒÉn√¢nc Azi?</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', sans-serif;
            background: #f5f5f7;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 0;
            padding-top: 70px;
        }

        .container {
            background: white;
            width: 100%;
            max-width: 1000px;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            box-shadow: none;
            border-radius: 0;
        }

        .header {
            text-align: center;
            padding: 60px 30px 40px;
            background: white;
            border-bottom: 1px solid #e5e5e7;
        }

        .header h1 {
            font-size: 2.5em;
            color: #1d1d1f;
            margin-bottom: 8px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .header p {
            font-size: 1em;
            color: #86868b;
            font-weight: 400;
            line-height: 1.6;
        }

        .button-container {
            text-align: center;
            padding: 30px 20px;
            background: white;
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            align-items: center;
        }

        button {
            background: #0071e3;
            color: white;
            border: none;
            padding: 12px 50px;
            font-size: 1em;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.2s, transform 0.2s;
            font-weight: 500;
            box-shadow: none;
            letter-spacing: -0.3px;
        }

        button:hover {
            background: #0077ed;
            transform: none;
        }

        button:active {
            background: #0064d2;
            transform: scale(0.98);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .menu-container {
            display: none;
            flex: 1;
        }

        .menu-container.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .menu-grid {
            display: flex;
            flex-direction: column;
            gap: 0;
            padding: 0;
        }

        .day-card {
            background: #f5f5f7;
            border-bottom: 1px solid #e5e5e7;
            padding: 20px 30px;
            box-shadow: none;
            cursor: pointer;
            border: none;
            transition: background 0.2s;
            border-radius: 0;
        }

        .day-card:hover {
            background: #efefef;
            box-shadow: none;
        }

        .day-card.show-ingredients {
            background: #f9f9fb;
            padding: 24px 30px;
            box-shadow: none;
            border: none;
        }

        .day-card.show-ingredients:hover {
            background: #f9f9fb;
        }

        .day-card.today {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: none;
        }

        .day-card.today:hover {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        }

        .day-card.today.show-ingredients {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        }

        .day-number {
            font-size: 0.75em;
            color: #86868b;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 6px;
            letter-spacing: 0.3px;
        }

        .day-card.today .day-number {
            color: #b45309;
        }

        .recipe-name {
            font-size: 1.2em;
            color: #1d1d1f;
            font-weight: 600;
            line-height: 1.4;
            cursor: pointer;
            transition: color 0.2s;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: space-between;
            letter-spacing: -0.3px;
        }

        .recipe-name:hover {
            color: #0071e3;
        }

        .day-card.today .recipe-name {
            color: #92400e;
        }

        .day-card.today .recipe-name:hover {
            color: #78350f;
        }

        .search-icon {
            display: inline-block;
            margin-left: 8px;
            font-size: 1.1em;
            opacity: 0.5;
            transition: opacity 0.2s;
        }

        .recipe-name:hover .search-icon {
            opacity: 0.8;
        }

        .ingredients-container {
            display: none;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(0, 0, 0, 0.06);
        }

        .ingredients-container.active {
            display: block;
            animation: slideDown 0.2s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .ingredients-title {
            font-size: 0.85em;
            font-weight: 600;
            color: #1d1d1f;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .day-card.today .ingredients-title {
            color: #92400e;
        }

        .ingredients-list {
            list-style: none;
            padding-left: 0;
        }

        .ingredients-list li {
            font-size: 0.9em;
            color: #555;
            padding: 4px 0;
            padding-left: 20px;
            position: relative;
            font-weight: 400;
            line-height: 1.5;
        }

        .ingredients-list li:before {
            content: "‚Ä¢";
            position: absolute;
            left: 0;
            color: #0071e3;
            font-weight: 700;
            font-size: 1.2em;
        }

        .day-card.today .ingredients-list li:before {
            color: #b45309;
        }

        .loading {
            text-align: center;
            font-size: 1em;
            color: #86868b;
            display: none;
            padding: 40px;
        }

        .loading.active {
            display: block;
        }

        /* Taburi naviga»õie */
        .tabs-container {
            display: flex;
            gap: 0;
            margin-bottom: 0;
            border-bottom: 1px solid #e5e5e7;
            flex-wrap: nowrap;
            background: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 16px 24px;
            font-size: 1em;
            cursor: pointer;
            color: #86868b;
            border-bottom: 3px solid transparent;
            transition: color 0.2s, border-color 0.2s;
            font-weight: 500;
            box-shadow: none;
            flex: 1;
            min-width: auto;
            white-space: nowrap;
            letter-spacing: -0.3px;
        }

        .tab-btn:hover {
            color: #1d1d1f;
            transform: none;
            box-shadow: none;
        }

        .tab-btn.active {
            background: none;
            color: #0071e3;
            border-radius: 0;
            border-bottom: 3px solid #0071e3;
        }

        /* Shopping List Styles */
        .shopping-list-container {
            display: none;
            flex: 1;
            padding: 0;
        }

        .shopping-list-container.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }

        .category {
            margin-bottom: 0;
            border-bottom: 1px solid #e5e5e7;
        }

        .category-header {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 16px 30px;
            background: white;
            color: #1d1d1f;
            border-radius: 0;
            margin-bottom: 0;
            transition: background 0.2s;
            user-select: none;
            border: none;
        }

        .category-header:hover {
            background: #f5f5f7;
            transform: none;
            box-shadow: none;
        }

        .category-header .toggle-icon {
            font-size: 1em;
            margin-right: 12px;
            transition: transform 0.2s;
        }

        .category-header.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }

        .category-name {
            font-weight: 600;
            font-size: 1em;
            flex-grow: 1;
            letter-spacing: -0.3px;
        }

        .category-count {
            background: #f5f5f7;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 0.85em;
            margin-left: auto;
            margin-right: 12px;
            color: #86868b;
            font-weight: 500;
        }

        .check-all-btn {
            background: #f5f5f7;
            border: none;
            color: #0071e3;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            transition: background 0.2s;
            white-space: nowrap;
            font-weight: 500;
        }

        .check-all-btn:hover {
            background: #efefef;
            border-color: transparent;
        }

        .category-items {
            display: flex;
            flex-direction: column;
            gap: 0;
            padding-left: 0;
            max-height: 70vh;
            overflow-y: auto;
            overflow-x: hidden;
            padding-right: 0;
            transition: opacity 0.2s ease-out;
            opacity: 1;
            background: #f9f9fb;
        }

        .category-items.collapsed {
            max-height: 0;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease-out, max-height 0s linear 0.2s;
        }

        /* Scrollbar styling */
        .category-items::-webkit-scrollbar {
            width: 6px;
        }

        .category-items::-webkit-scrollbar-track {
            background: transparent;
        }

        .category-items::-webkit-scrollbar-thumb {
            background: #d5d5d7;
            border-radius: 3px;
        }

        .category-items::-webkit-scrollbar-thumb:hover {
            background: #a1a1a6;
        }

        .item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 30px;
            background: #f9f9fb;
            border-radius: 0;
            transition: background 0.2s;
            min-height: 48px;
            border-bottom: 1px solid #e5e5e7;
        }

        .item:hover {
            background: #f5f5f7;
        }

        .item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #0071e3;
            flex-shrink: 0;
            border-radius: 4px;
        }

        .item-name {
            flex: 1;
            min-width: 0;
            color: #333;
            font-weight: 500;
            word-break: break-word;
            font-size: 0.95em;
        }

        .item input[type="checkbox"]:checked ~ .item-name {
            text-decoration: line-through;
            color: #a1a1a6;
        }

        .item-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;
            margin-left: auto;
            padding-left: 12px;
            border-left: none;
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        .quantity-btn {
            background: white;
            color: #0071e3;
            border: 1px solid #d5d5d7;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            padding: 0;
            flex-shrink: 0;
        }

        .quantity-btn:hover {
            background: #f5f5f7;
            border-color: #0071e3;
        }

        .quantity-display {
            min-width: 32px;
            text-align: center;
            font-weight: 600;
            color: #333;
            font-size: 0.9em;
            flex-shrink: 0;
        }

        .item-delete {
            background: white;
            color: #d70015;
            border: 1px solid #d70015;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 500;
            transition: all 0.2s;
            flex-shrink: 0;
            white-space: nowrap;
        }

        .item-delete:hover {
            background: #d70015;
            color: white;
        }

        .add-item-section {
            display: flex;
            gap: 12px;
            padding: 24px 30px;
            background: white;
            border-radius: 0;
            border-bottom: 1px solid #e5e5e7;
        }

        .add-item-section select,
        .add-item-section input,
        .add-item-section button {
            padding: 10px 14px;
            border: 1px solid #d5d5d7;
            border-radius: 8px;
            font-size: 0.95em;
        }

        .add-item-section select {
            flex: 0 0 auto;
            background: white;
            cursor: pointer;
            min-width: 180px;
        }

        .add-item-section input {
            flex: 1;
            min-width: 200px;
            font-weight: 400;
        }

        .add-item-section button {
            background: #0071e3;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 500;
            white-space: nowrap;
            box-shadow: none;
        }

        .add-item-section button:hover {
            background: #0077ed;
            transform: none;
            box-shadow: none;
        }

        .stats {
            display: flex;
            gap: 12px;
            padding: 24px 30px;
            justify-content: flex-start;
            flex-wrap: wrap;
            background: white;
            border-bottom: 1px solid #e5e5e7;
        }

        .undo-popup {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #1d1d1f;
            color: white;
            padding: 0;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            animation: slideUp 0.3s ease-out;
        }

        .undo-popup-content {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            font-weight: 500;
            font-size: 0.95em;
        }

        .undo-popup button {
            background: white;
            color: #0071e3;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
            font-size: 0.85em;
        }

        .undo-popup button:hover {
            background: #f5f5f7;
        }

        @keyframes slideUp {
            from {
                transform: translateX(-50%) translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        .stat {
            text-align: center;
            padding: 12px 20px;
            background: #f5f5f7;
            color: #1d1d1f;
            border-radius: 8px;
            font-weight: 600;
            flex: 0 0 auto;
            min-width: 120px;
        }

        .stat-number {
            font-size: 1.5em;
            display: block;
            margin-bottom: 4px;
            font-weight: 700;
        }

        .stat-label {
            font-size: 0.8em;
            color: #86868b;
            font-weight: 500;
        }

        @media (max-width: 768px) {
            .container {
                padding: 0;
            }

            .header {
                padding: 40px 20px 30px;
            }

            .header h1 {
                font-size: 1.8em;
                margin-bottom: 6px;
            }

            .header p {
                font-size: 0.95em;
            }

            .menu-grid {
                gap: 0;
            }

            .day-card {
                padding: 16px 20px;
            }

            .day-card.show-ingredients {
                padding: 20px;
            }

            .button-container {
                padding: 20px 16px;
                gap: 12px;
            }

            .button-container button {
                flex: 0 1 auto;
                min-width: 160px;
            }

            .recipe-name {
                font-size: 1em;
                line-height: 1.3;
            }

            .add-item-section {
                flex-direction: column;
                padding: 16px;
                gap: 8px;
            }

            .add-item-section select {
                flex: 1;
                min-width: auto;
            }

            .tabs-container {
                flex-wrap: wrap;
            }

            .tab-btn {
                padding: 12px 16px;
                font-size: 0.9em;
                min-width: auto;
                flex: 1;
            }

            .stats {
                gap: 8px;
                padding: 16px;
            }

            .stat {
                padding: 10px 12px;
                min-width: 90px;
                flex: 1;
            }

            .stat-number {
                font-size: 1.3em;
            }

            .stat-label {
                font-size: 0.75em;
            }

            .category-items {
                padding-left: 0;
            }

            .item {
                gap: 8px;
                padding: 10px 16px;
                min-height: 44px;
            }

            .item-controls {
                gap: 8px;
            }

            .quantity-btn {
                width: 28px;
                height: 28px;
                font-size: 0.9em;
            }

            .item-delete {
                padding: 4px 8px;
                font-size: 0.75em;
            }

            .check-all-btn {
                padding: 4px 8px;
                font-size: 0.75em;
            }

            .category-header {
                padding: 12px 16px;
            }

            .category-count {
                font-size: 0.8em;
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: 30px 16px 24px;
            }

            .header h1 {
                font-size: 1.5em;
            }

            .tab-btn {
                padding: 10px 12px;
                font-size: 0.85em;
                min-width: auto;
            }

            .button-container {
                padding: 16px 12px;
                gap: 10px;
            }

            button {
                padding: 10px 40px;
                font-size: 0.95em;
                flex: 1;
                min-width: 120px;
            }

            .add-item-section {
                padding: 12px;
            }

            .stat {
                padding: 8px 10px;
                flex: 1;
            }

            .stat-number {
                font-size: 1.2em;
            }

            .item {
                padding: 8px 12px;
                gap: 6px;
            }

            .quantity-btn {
                width: 26px;
                height: 26px;
                font-size: 0.85em;
            }

            .item-delete {
                padding: 3px 6px;
                font-size: 0.7em;
            }

            .category-header {
                padding: 10px 12px;
            }

            .day-card {
                padding: 12px 16px;
            }
        }

        body { touch-action: manipulation; }
        button { touch-action: manipulation; }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            padding: 40px 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            font-size: 1.5em;
            font-weight: 700;
            margin-bottom: 20px;
            color: #1d1d1f;
        }

        .modal-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .modal-form input {
            padding: 12px 15px;
            border: 1px solid #d5d5d7;
            border-radius: 8px;
            font-size: 1em;
            font-family: inherit;
        }

        .modal-form input:focus {
            outline: none;
            border-color: #0071e3;
        }

        .modal-error {
            background: #fee;
            color: #d70015;
            padding: 10px 12px;
            border-radius: 8px;
            font-size: 0.9em;
            margin-bottom: 10px;
            display: none;
        }

        .modal-error.active {
            display: block;
        }

        .modal-toggle {
            text-align: center;
            margin-top: 15px;
            font-size: 0.9em;
            color: #86868b;
        }

        .modal-toggle a {
            color: #0071e3;
            cursor: pointer;
            text-decoration: underline;
        }

        .user-button {
            position: absolute;
            top: 20px;
            right: 120px;
            background: white;
            color: #0071e3;
            border: 1px solid #0071e3;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            z-index: 100;
        }

        .user-button:hover {
            background: #f5f5f7;
        }

        /* Profile Page */
        #profile-tab {
            display: none;
        }

        #profile-tab.active {
            display: block;
        }

        .profile-container {
            padding: 30px;
            max-width: 600px;
            margin: 0 auto;
        }

        .profile-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e5e5e7;
        }

        .profile-header h2 {
            font-size: 1.5em;
            color: #1d1d1f;
            margin-bottom: 5px;
        }

        .profile-header p {
            color: #86868b;
        }

        .profile-section {
            margin-bottom: 30px;
        }

        .profile-section h3 {
            font-size: 1.1em;
            font-weight: 600;
            color: #1d1d1f;
            margin-bottom: 15px;
        }

        .diet-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }

        .diet-option {
            padding: 12px 15px;
            border: 2px solid #e5e5e7;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            text-align: center;
            font-weight: 500;
        }

        .diet-option:hover {
            border-color: #0071e3;
            background: #f5f5f7;
        }

        .diet-option.selected {
            background: #0071e3;
            color: white;
            border-color: #0071e3;
        }

        .allergy-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .allergy-tag {
            background: #e5e5e7;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .allergy-tag .remove {
            cursor: pointer;
            font-weight: bold;
            color: #d70015;
        }

        .profile-buttons {
            display: flex;
            gap: 10px;
            margin-top: 30px;
        }

        .profile-buttons button {
            flex: 1;
        }

        .profile-buttons .danger {
            background: #d70015;
        }

        .profile-buttons .danger:hover {
            background: #b30012;
        }

        /* Top header bar layout fix */
        #headerBar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            align-items: center;
            padding: 15px 20px;
            background: white;
            border-bottom: 1px solid #e5e5e7;
            z-index: 100;
            width: 100%;
            box-sizing: border-box;
        }

        /* Ensure buttons don't overlap */
        #headerBar select,
        #headerBar button {
            flex-shrink: 0;
        }
    </style>
</style>
    <!-- jsPDF library for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
        <!-- Top Header Bar -->
        <div id="headerBar">
            <!-- Language Selector -->
            <select id="languageSelect" onchange="setLanguage(this.value)" style="padding: 8px 12px; border-radius: 8px; border: 1px solid #d5d5d7; font-size: 0.9em; cursor: pointer; background: white; white-space: nowrap;" title="Alege limba">
                <option value="ro">üá∑üá¥ Rom√¢nƒÉ</option>
                <option value="en">üá¨üáß English</option>
                <option value="fr">üá´üá∑ Fran√ßais</option>
            </select>
            <!-- User Button -->
            <button class="user-button" id="userButton" onclick="toggleLoginModal()" style="white-space: nowrap;">üë§ Login</button>
        </div>

        <!-- Auth Modal -->
        <div id="authModal" class="modal">
            <div class="modal-content">
                <div class="modal-error" id="authError"></div>
                <div id="loginForm">
                    <div class="modal-header">üîê Conectare</div>
                    <div class="modal-form">
                        <input type="email" id="loginEmail" placeholder="Email">
                        <input type="password" id="loginPassword" placeholder="ParolƒÉ">
                        <button onclick="handleLogin()">ConecteazƒÉ-te</button>
                        <div class="modal-toggle">Nu ai cont? <a onclick="switchAuthMode('register')">√énregistrare</a></div>
                    </div>
                </div>
                <div id="registerForm" style="display: none;">
                    <div class="modal-header">üìù √énregistrare</div>
                    <div class="modal-form">
                        <input type="email" id="registerEmail" placeholder="Email">
                        <input type="password" id="registerPassword" placeholder="ParolƒÉ (min 6 caractere)">
                        <input type="password" id="registerPassword2" placeholder="ConfirmƒÉ parola">
                        <button onclick="handleRegister()">√énregistreazƒÉ-te</button>
                        <div class="modal-toggle">Ai cont? <a onclick="switchAuthMode('login')">Conectare</a></div>
                    </div>
                </div>
            </div>
        </div>

    <div class="container">
        <div class="header">
            <h1>üçΩÔ∏è CE MƒÇN√ÇNC AZI?</h1>
            <p>GenereazƒÉ meniul tƒÉu sƒÉptƒÉm√¢nal & gestioneazƒÉ cumpƒÉrƒÉturile</p>
        </div>

        <!-- Taburi Naviga»õie -->
        <div class="tabs-container">
            <button class="tab-btn active" onclick="switchTab('menu')" title="GenereazƒÉ »ôi afi»ôeazƒÉ meniu sƒÉptƒÉm√¢nal">üìÖ Menu SƒÉptƒÉm√¢nal</button>
            <button class="tab-btn" onclick="switchTab('shopping')" title="GestioneazƒÉ lista de cumpƒÉrƒÉturi">üõí Lista de CumpƒÉrƒÉturi</button>
            <button class="tab-btn" id="profileTabBtn" style="display: none;" onclick="switchTab('profile')" title="Vezi »ôi modificƒÉ preferin»õele tale">üë§ Profil</button>
            <button class="tab-btn" onclick="switchTab('import')" title="ImportƒÉ re»õete din CSV">üì• Import Re»õete</button>
            <button class="tab-btn" onclick="switchTab('analytics')" title="Vezi statistici re»õete">üìä Statistici</button>
            <button class="tab-btn" onclick="switchTab('calendar')" title="PlanificƒÉ meniuri pe calendar">üìÜ Calendar</button>
        </div>

        <!-- Tab 1: Menu -->
        <div id="menu-tab">
            <div class="button-container">
                <button id="generateBtn" onclick="generateMenu()">GENEREAZƒÇ MENIU</button>
                <button id="exportMenuBtn" onclick="exportMenuToPDF()" style="display: none; background: #34c759;">üìÑ Export PDF</button>
            </div>

            <div class="loading" id="loading">
                ‚è≥ Se genereazƒÉ meniu...
            </div>

            <div class="menu-container" id="menuContainer">
                <div class="menu-grid" id="menuGrid"></div>
            </div>
        </div>

        <!-- Tab 2: Shopping List -->
        <div id="shopping-tab" style="display: none;">
            <div class="add-item-section">
                <select id="categorySelect">
                    <option value="">SelecteazƒÉ categorie...</option>
                </select>
                <input type="text" id="productInput" placeholder="Introduce»õi produsul nou (ex: FƒÉinƒÉ 4 kg)">
                <button onclick="addProduct()">‚ûï AdaugƒÉ Produs</button>
                <button onclick="generateShareLink()" style="background: #fff3e0; color: #ff9800; border: 2px solid #ff9800; margin-left: 8px; font-weight: 700;">üîó PartajeazƒÉ Lista</button>
                <button onclick="exportShoppingListToPDF()" style="background: #34c759; color: white; margin-left: 8px; font-weight: 700;">üìÑ Export PDF</button>
            </div>

            <div class="stats" id="stats-container">
                <div class="stat">
                    <span class="stat-number" id="total-items">0</span>
                    <span class="stat-label">Produse Total</span>
                </div>
                <div class="stat">
                    <span class="stat-number" id="checked-items">0</span>
                    <span class="stat-label">CumpƒÉrate</span>
                </div>
                <div class="stat">
                    <span class="stat-number" id="remaining-items">0</span>
                    <span class="stat-label">RƒÉmase</span>
                </div>
            </div>

            <div class="shopping-list-container active" id="shoppingListContainer"></div>
        </div>

        <!-- Tab 3: Profile -->
        <div id="profile-tab">
            <div class="profile-container">
                <div class="profile-header">
                    <h2 id="profileName">üë§ Profilul Meu</h2>
                    <p id="profileEmail">-</p>
                </div>

                <div class="profile-section">
                    <h3>ü•ò Tip de DietƒÉ</h3>
                    <div class="diet-options">
                        <div class="diet-option" onclick="selectDiet('balanced')">Echilibrat</div>
                        <div class="diet-option" onclick="selectDiet('vegetarian')">Vegetarian</div>
                        <div class="diet-option" onclick="selectDiet('vegan')">Vegan</div>
                        <div class="diet-option" onclick="selectDiet('keto')">Keto</div>
                    </div>
                </div>

                <div class="profile-section">
                    <h3>‚ö†Ô∏è Alergii »ôi Restric»õii</h3>
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <input type="text" id="allergyInput" placeholder="Ex: Arahide, LactozƒÉ..." style="flex: 1; padding: 10px 12px; border: 1px solid #d5d5d7; border-radius: 8px;">
                        <button onclick="addAllergy()" style="padding: 10px 20px;">AdaugƒÉ</button>
                    </div>
                    <div class="allergy-list" id="allergyList"></div>
                </div>

                <div class="profile-section">
                    <h3>üåê LimbƒÉ PreferatƒÉ</h3>
                    <select id="profileLanguage" onchange="updateLanguagePref(this.value)" style="padding: 10px 12px; border: 1px solid #d5d5d7; border-radius: 8px; font-size: 0.95em; width: 100%;">
                        <option value="ro">üá∑üá¥ Rom√¢nƒÉ</option>
                        <option value="en">üá¨üáß English</option>
                        <option value="fr">üá´üá∑ Fran√ßais</option>
                    </select>
                </div>

                <div class="profile-buttons">
                    <button onclick="savePreferences()">üíæ SalveazƒÉ Preferin»õe</button>
                    <button class="danger" onclick="logout()">üö™ Deconectare</button>
                </div>
            </div>
        </div>

        <!-- Tab 4: Import Re»õete -->
        <div id="import-tab" style="display: none;">
            <div class="profile-container">
                <div class="profile-header">
                    <h2>üì• Import Re»õete din CSV</h2>
                    <p>AdaugƒÉ re»õete noi din fi»ôier CSV</p>
                </div>

                <div class="profile-section">
                    <h3>Format CSV necesar:</h3>
                    <pre style="background: #f5f5f7; padding: 15px; border-radius: 8px; font-size: 0.85em; overflow-x: auto;">Nume,Ingrediente,Proteina
Pasta cu pesto,paste|pesto|br√¢nzƒÉ|ulei,ouƒÉ
SalatƒÉ Cezar,salatƒÉ|cezar dressing|p√¢ine,ouƒÉ</pre>
                </div>

                <div class="profile-section">
                    <h3>Alege fi»ôier CSV:</h3>
                    <input type="file" id="csvFile" accept=".csv" style="padding: 10px 12px; border: 1px solid #d5d5d7; border-radius: 8px; width: 100%; cursor: pointer;">
                </div>

                <div id="importError" style="display: none; background: #fee; color: #d70015; padding: 15px; border-radius: 8px; margin-bottom: 15px;"></div>

                <div id="importPreview" style="display: none; margin-bottom: 20px;">
                    <h3>Preview (primele 3 re»õete):</h3>
                    <div id="importPreviewContent" style="background: #f5f5f7; padding: 15px; border-radius: 8px;"></div>
                </div>

                <div class="profile-buttons">
                    <button onclick="parseAndPreviewCSV()">üëÅÔ∏è Preview Import</button>
                    <button onclick="importRecipesFromCSV()" style="background: #34c759;">‚úÖ ImportƒÉ Re»õetele</button>
                </div>

                <div id="importStats" style="display: none; margin-top: 20px; padding: 15px; background: #efe; border-radius: 8px;"></div>
            </div>
        </div>

        <!-- Tab 5: Statistici -->
        <div id="analytics-tab" style="display: none;">
            <div class="profile-container">
                <div class="profile-header">
                    <h2>üìä Statistici Re»õete</h2>
                    <p>Analiza utilizƒÉrii re»õetelor</p>
                </div>

                <div id="analyticsContent">
                    <div class="profile-section">
                        <h3>Top 5 Re»õete Preferate:</h3>
                        <div id="topRecipes" style="background: #f5f5f7; padding: 15px; border-radius: 8px;"></div>
                    </div>

                    <div class="profile-section">
                        <h3>Distribu»õie Proteine:</h3>
                        <div id="proteinStats" style="background: #f5f5f7; padding: 15px; border-radius: 8px;"></div>
                    </div>

                    <div class="profile-section">
                        <h3>Total Re»õete:</h3>
                        <div id="totalStats" style="background: #f5f5f7; padding: 15px; border-radius: 8px; font-size: 1.2em; font-weight: bold;"></div>
                    </div>

                    <button onclick="resetAnalytics()" style="background: #d70015; margin-top: 20px;">üîÑ Reset Statistici</button>
                </div>
            </div>
        </div>

        <!-- Tab 6: Calendar Planificare -->
        <div id="calendar-tab" style="display: none;">
            <div class="profile-container">
                <div class="profile-header">
                    <h2>üìÜ Planificator Meniuri</h2>
                    <p>PlanificƒÉ meniuri pe zilele viitoare</p>
                </div>

                <div class="profile-section">
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <button onclick="previousMonth()" style="padding: 8px 15px;" title="Mergi la luna anterioarƒÉ">‚Üê Luna AnterioarƒÉ</button>
                        <div style="flex: 1; text-align: center; padding: 8px; font-weight: bold;" id="monthDisplay">Ian 2026</div>
                        <button onclick="nextMonth()" style="padding: 8px 15px;" title="Mergi la luna urmƒÉtoare">Luna UrmƒÉtoare ‚Üí</button>
                    </div>
                    <div id="calendarView" style="background: #f5f5f7; padding: 15px; border-radius: 8px;"></div>
                </div>

                <div class="profile-section" id="selectedDateDiv"></div>

                <div class="profile-section">
                    <h3>üìÖ Zile Planificate:</h3>
                    <div id="plannedDaysList" style="background: #f5f5f7; padding: 15px; border-radius: 8px; max-height: 300px; overflow-y: auto;"></div>
                </div>

                <div class="profile-buttons">
                    <button onclick="exportCalendarToPDF()" style="background: #34c759;" title="ExportƒÉ planul calendarului √Æn PDF">üìÑ Export Calendar PDF</button>
                    <button onclick="clearAllPlans()" style="background: #d70015;" title="»òterge toate planurile din calendar">üóëÔ∏è »òterge Planuri</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Translation system
        const translations = {
            ro: {
                title: 'üçΩÔ∏è CE MƒÇN√ÇNC AZI?',
                subtitle: 'GenereazƒÉ meniul tƒÉu sƒÉptƒÉm√¢nal & gestioneazƒÉ cumpƒÉrƒÉturile',
                menuTab: 'üìÖ Menu SƒÉptƒÉm√¢nal',
                shoppingTab: 'üõí Lista de CumpƒÉrƒÉturi',
                generateBtn: 'GENEREAZƒÇ MENIU',
                loading: '‚è≥ Se genereazƒÉ meniu...',
                selectCategory: 'SelecteazƒÉ categorie...',
                addProduct: 'Introduce»õi produsul nou (ex: FƒÉinƒÉ 4 kg)',
                addBtn: '‚ûï AdaugƒÉ Produs',
                shareBtn: 'üîó PartajeazƒÉ Lista',
                totalItems: 'Produse Total',
                checkedItems: 'CumpƒÉrate',
                remainingItems: 'RƒÉmase',
                ingredientsAvailable: 'üì¶ Ingrediente:',
                noIngredients: 'Nicio ingredientƒÉ disponibilƒÉ'
            },
            en: {
                title: 'üçΩÔ∏è WHAT AM I EATING TODAY?',
                subtitle: 'Generate your weekly menu & manage your shopping list',
                menuTab: 'üìÖ Weekly Menu',
                shoppingTab: 'üõí Shopping List',
                generateBtn: 'GENERATE MENU',
                loading: '‚è≥ Generating menu...',
                selectCategory: 'Select category...',
                addProduct: 'Enter new product (ex: Flour 4 kg)',
                addBtn: '‚ûï Add Product',
                shareBtn: 'üîó Share List',
                totalItems: 'Total Products',
                checkedItems: 'Purchased',
                remainingItems: 'Remaining',
                ingredientsAvailable: 'üì¶ Ingredients:',
                noIngredients: 'No ingredients available'
            },
            fr: {
                title: 'üçΩÔ∏è QUE VAIS-JE MANGER AUJOURD\'HUI?',
                subtitle: 'G√©n√©rez votre menu hebdomadaire & g√©rez votre liste d\'achat',
                menuTab: 'üìÖ Menu Hebdomadaire',
                shoppingTab: 'üõí Liste d\'Achat',
                generateBtn: 'G√âN√âRER LE MENU',
                loading: '‚è≥ G√©n√©ration du menu...',
                selectCategory: 'S√©lectionner une cat√©gorie...',
                addProduct: 'Entrez un nouveau produit (ex: Farine 4 kg)',
                addBtn: '‚ûï Ajouter Produit',
                shareBtn: 'üîó Partager la Liste',
                totalItems: 'Total Produits',
                checkedItems: 'Achet√©s',
                remainingItems: 'Restants',
                ingredientsAvailable: 'üì¶ Ingr√©dients:',
                noIngredients: 'Aucun ingr√©dient disponible'
            }
        };

        let currentLang = localStorage.getItem('language') || 'ro';
        let t = translations[currentLang];

        let recipesData = {}; 
        let expandedCard = null;
        let shoppingList = {};
        let previousMenuRecipes = new Set(); // Tracker pentru re»õete afi»ôate anterior

        // Global auth state
        let currentUser = null;
        let currentToken = null;
        let userPreferences = {
            dietType: 'balanced',
            allergies: [],
            restrictions: [],
            language: 'ro'
        };

        // Auth Functions
        function toggleLoginModal() {
            const modal = document.getElementById('authModal');
            modal.classList.toggle('active');
        }

        function switchAuthMode(mode) {
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            const error = document.getElementById('authError');
            error.classList.remove('active');
            
            if (mode === 'login') {
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
            } else {
                loginForm.style.display = 'none';
                registerForm.style.display = 'block';
            }
        }

        async function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const error = document.getElementById('authError');

            if (!email || !password) {
                error.textContent = 'Email »ôi parolƒÉ sunt obligatorii';
                error.classList.add('active');
                return;
            }

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (!response.ok) {
                    error.textContent = data.error || 'Eroare la conectare';
                    error.classList.add('active');
                    return;
                }

                currentToken = data.token;
                currentUser = { email: data.email, userId: data.userId };
                userPreferences = data.preferences;
                localStorage.setItem('authToken', data.token);
                localStorage.setItem('currentUser', JSON.stringify(currentUser));

                updateUserUI();
                toggleLoginModal();
                document.getElementById('loginEmail').value = '';
                document.getElementById('loginPassword').value = '';
                error.classList.remove('active');

            } catch (err) {
                error.textContent = 'Eroare la conectare: ' + err.message;
                error.classList.add('active');
            }
        }

        async function handleRegister() {
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const password2 = document.getElementById('registerPassword2').value;
            const error = document.getElementById('authError');

            if (!email || !password || !password2) {
                error.textContent = 'CompleteazƒÉ toate c√¢mpurile';
                error.classList.add('active');
                return;
            }

            if (password !== password2) {
                error.textContent = 'Parolele nu se potrivesc';
                error.classList.add('active');
                return;
            }

            if (password.length < 6) {
                error.textContent = 'Parola trebuie sƒÉ aibƒÉ cel pu»õin 6 caractere';
                error.classList.add('active');
                return;
            }

            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (!response.ok) {
                    error.textContent = data.error || 'Eroare la √Ænregistrare';
                    error.classList.add('active');
                    return;
                }

                currentToken = data.token;
                currentUser = { email: data.email, userId: data.userId };
                userPreferences = data.preferences;
                localStorage.setItem('authToken', data.token);
                localStorage.setItem('currentUser', JSON.stringify(currentUser));

                updateUserUI();
                toggleLoginModal();
                document.getElementById('registerEmail').value = '';
                document.getElementById('registerPassword').value = '';
                document.getElementById('registerPassword2').value = '';
                error.classList.remove('active');
                switchAuthMode('login');

            } catch (err) {
                error.textContent = 'Eroare la √Ænregistrare: ' + err.message;
                error.classList.add('active');
            }
        }

        function logout() {
            if (confirm('E»ôti sigur cƒÉ vrei sƒÉ te deconectezi?')) {
                currentUser = null;
                currentToken = null;
                userPreferences = { dietType: 'balanced', allergies: [], restrictions: [], language: 'ro' };
                localStorage.removeItem('authToken');
                localStorage.removeItem('currentUser');
                updateUserUI();
                switchTab('menu');
            }
        }

        function updateUserUI() {
            const userButton = document.getElementById('userButton');
            const profileTabBtn = document.getElementById('profileTabBtn');

            if (currentUser) {
                userButton.textContent = `üë§ ${currentUser.email.split('@')[0]}`;
                userButton.style.color = '#1d1d1f';
                userButton.style.borderColor = '#d5d5d7';
                profileTabBtn.style.display = 'block';
                updateProfilePage();
            } else {
                userButton.textContent = 'üë§ Login';
                userButton.style.color = '#0071e3';
                userButton.style.borderColor = '#0071e3';
                profileTabBtn.style.display = 'none';
            }
        }

        function updateProfilePage() {
            document.getElementById('profileName').textContent = `üë§ ${currentUser.email}`;
            document.getElementById('profileEmail').textContent = currentUser.email;
            
            document.querySelectorAll('.diet-option').forEach(option => {
                option.classList.remove('selected');
            });
            document.querySelectorAll('.diet-option').forEach(option => {
                const optionText = option.textContent.toLowerCase();
                const dietType = userPreferences.dietType.toLowerCase();
                if ((dietType === 'balanced' && optionText.includes('echilibrat')) ||
                    (dietType === 'vegetarian' && optionText.includes('vegetarian')) ||
                    (dietType === 'vegan' && optionText.includes('vegan')) ||
                    (dietType === 'keto' && optionText.includes('keto'))) {
                    option.classList.add('selected');
                }
            });

            renderAllergies();
            document.getElementById('profileLanguage').value = currentLang;
        }

        function selectDiet(dietType) {
            userPreferences.dietType = dietType;
            document.querySelectorAll('.diet-option').forEach(option => {
                option.classList.remove('selected');
            });
            event.target.classList.add('selected');
        }

        function addAllergy() {
            const input = document.getElementById('allergyInput');
            const allergy = input.value.trim();
            if (allergy && !userPreferences.allergies.includes(allergy)) {
                userPreferences.allergies.push(allergy);
                input.value = '';
                renderAllergies();
            }
        }

        function removeAllergy(allergy) {
            userPreferences.allergies = userPreferences.allergies.filter(a => a !== allergy);
            renderAllergies();
        }

        function renderAllergies() {
            const allergyList = document.getElementById('allergyList');
            allergyList.innerHTML = userPreferences.allergies.map(allergy => 
                `<div class="allergy-tag">${allergy} <span class="remove" onclick="removeAllergy('${allergy}')">‚úï</span></div>`
            ).join('');
        }

        function updateLanguagePref(lang) {
            userPreferences.language = lang;
        }

        async function savePreferences() {
            if (!currentToken) {
                alert('Trebuie sƒÉ fii conectat');
                return;
            }

            try {
                const response = await fetch('/api/user/preferences', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: JSON.stringify(userPreferences)
                });

                const data = await response.json();

                if (!response.ok) {
                    alert(data.error || 'Eroare la salvare');
                    return;
                }

                alert('Preferin»õele au fost salvate cu succes!');
                userPreferences = data.preferences;
            } catch (err) {
                alert('Eroare: ' + err.message);
            }
        }

        function checkAuthStatus() {
            const token = localStorage.getItem('authToken');
            const user = localStorage.getItem('currentUser');
            
            if (token && user) {
                currentToken = token;
                currentUser = JSON.parse(user);
                updateUserUI();
            }
        }

        checkAuthStatus();

        // Analytics state
        let recipeUsageStats = JSON.parse(localStorage.getItem('recipeStats')) || {};
        let csvRecipes = JSON.parse(localStorage.getItem('csvRecipes')) || [];
        let selectedCSVData = null;

        function parseAndPreviewCSV() {
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];
            const errorDiv = document.getElementById('importError');
            const previewDiv = document.getElementById('importPreview');
            const previewContent = document.getElementById('importPreviewContent');

            errorDiv.style.display = 'none';
            previewDiv.style.display = 'none';

            if (!file) {
                errorDiv.textContent = 'Te rog selecteazƒÉ un fi»ôier CSV';
                errorDiv.style.display = 'block';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\n').filter(line => line.trim());
                    
                    if (lines.length < 2) {
                        errorDiv.textContent = 'Fi»ôierul CSV trebuie sƒÉ aibƒÉ cel pu»õin header + 1 re»õetƒÉ';
                        errorDiv.style.display = 'block';
                        return;
                    }

                    const header = lines[0].split(',').map(h => h.trim());
                    if (header[0] !== 'Nume' || header[1] !== 'Ingrediente' || header[2] !== 'Proteina') {
                        errorDiv.textContent = 'Header CSV invalid. Trebuie: Nume,Ingrediente,Proteina';
                        errorDiv.style.display = 'block';
                        return;
                    }

                    const recipes = [];
                    for (let i = 1; i < lines.length; i++) {
                        const parts = lines[i].split(',').map(p => p.trim());
                        if (parts.length >= 3 && parts[0]) {
                            recipes.push({
                                Nume: parts[0],
                                Ingrediente: parts[1].split('|'),
                                Proteina: parts[2]
                            });
                        }
                    }

                    if (recipes.length === 0) {
                        errorDiv.textContent = 'Nu s-au gƒÉsit re»õete valide √Æn CSV';
                        errorDiv.style.display = 'block';
                        return;
                    }

                    selectedCSVData = recipes;

                    // Preview
                    let previewHTML = `<p style="color: #86868b; margin-bottom: 15px;">Total re»õete √Æn fi»ôier: ${recipes.length}</p>`;
                    recipes.slice(0, 3).forEach(recipe => {
                        previewHTML += `
                            <div style="padding: 10px; border-bottom: 1px solid #e5e5e7;">
                                <strong>${recipe.Nume}</strong><br>
                                <small style="color: #86868b;">Proteina: ${recipe.Proteina}</small><br>
                                <small>${recipe.Ingrediente.join(', ')}</small>
                            </div>
                        `;
                    });
                    
                    previewContent.innerHTML = previewHTML;
                    previewDiv.style.display = 'block';

                } catch (error) {
                    errorDiv.textContent = 'Eroare la parsare CSV: ' + error.message;
                    errorDiv.style.display = 'block';
                }
            };
            reader.readAsText(file);
        }

        function importRecipesFromCSV() {
            if (!selectedCSVData || selectedCSVData.length === 0) {
                alert('Te rog fƒÉ preview mai √Ænt√¢i');
                return;
            }

            csvRecipes = [...csvRecipes, ...selectedCSVData];
            localStorage.setItem('csvRecipes', JSON.stringify(csvRecipes));

            const statsDiv = document.getElementById('importStats');
            statsDiv.innerHTML = `‚úÖ ${selectedCSVData.length} re»õete importate cu succes!<br>Total re»õete √Æn bazƒÉ: ${csvRecipes.length}`;
            statsDiv.style.display = 'block';

            // Reset form
            document.getElementById('csvFile').value = '';
            selectedCSVData = null;
            document.getElementById('importPreview').style.display = 'none';
        }

        function trackRecipeUsage(recipeName) {
            if (!recipeName || recipeName === 'Nicio re»õetƒÉ disponibilƒÉ') return;
            
            recipeUsageStats[recipeName] = (recipeUsageStats[recipeName] || 0) + 1;
            localStorage.setItem('recipeStats', JSON.stringify(recipeUsageStats));
        }

        function loadAnalytics() {
            const topRecipesDiv = document.getElementById('topRecipes');
            const proteinStatsDiv = document.getElementById('proteinStats');
            const totalStatsDiv = document.getElementById('totalStats');

            // Top 5 re»õete
            const sorted = Object.entries(recipeUsageStats)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            if (sorted.length === 0) {
                topRecipesDiv.innerHTML = '<p style="color: #86868b;">Nicio re»õetƒÉ √ÆncƒÉ. GenereazƒÉ meniuri pentru a vedea statistici.</p>';
            } else {
                topRecipesDiv.innerHTML = sorted.map((entry, idx) => 
                    `<div style="padding: 10px; ${idx % 2 === 0 ? 'background: white' : 'background: #fafafa'}">
                        ${idx + 1}. <strong>${entry[0]}</strong> - ${entry[1]} ori
                    </div>`
                ).join('');
            }

            // Distribu»õie proteine
            proteinStatsDiv.innerHTML = `<p style="color: #86868b;">Statistici detaliate √Æn lucru...</p>`;

            // Total
            const totalRecipes = 18 + csvRecipes.length;
            totalStatsDiv.innerHTML = `${totalRecipes} re»õete disponibile | ${Object.keys(recipeUsageStats).length} utilizate`;
        }

        function resetAnalytics() {
            if (confirm('»òtergi toate statisticile?')) {
                recipeUsageStats = {};
                localStorage.removeItem('recipeStats');
                loadAnalytics();
            }
        }

        function setLanguage(lang) {
            currentLang = lang;
            t = translations[lang];
            localStorage.setItem('language', lang);
            updateAllText();
            renderShoppingList();
        }

        function updateAllText() {
            document.querySelector('.header h1').textContent = t.title;
            document.querySelector('.header p').textContent = t.subtitle;
            document.querySelectorAll('.tab-btn')[0].textContent = t.menuTab;
            document.querySelectorAll('.tab-btn')[1].textContent = t.shoppingTab;
            document.getElementById('generateBtn').textContent = t.generateBtn;
            document.getElementById('loading').textContent = t.loading;
            document.getElementById('categorySelect').innerHTML = `<option value="">${t.selectCategory}</option>`;
            document.getElementById('productInput').placeholder = t.addProduct;
            document.querySelectorAll('.add-item-section button')[0].textContent = t.addBtn;
            document.querySelectorAll('.add-item-section button')[1].textContent = t.shareBtn;
            document.querySelectorAll('.stat-label')[0].textContent = t.totalItems;
            document.querySelectorAll('.stat-label')[1].textContent = t.checkedItems;
            document.querySelectorAll('.stat-label')[2].textContent = t.remainingItems;
            populateCategorySelect();
        }

        // Ini»õializare lista de cumpƒÉrƒÉturi - structura noua cu cantitate
        const defaultShoppingList = {
            "ü•¨ Legume / Fructe": {
                "Banane üçå": { checked: false, quantity: 1 },
                "Avocado ü•ë": { checked: false, quantity: 1 },
                "Ro»ôii üçÖ": { checked: false, quantity: 1 },
                "Clementine üçä": { checked: false, quantity: 1 },
                "Cartofi ü•î": { checked: false, quantity: 1 },
                "CeapƒÉ üßÖ": { checked: false, quantity: 1 },
                "Castrave»õi ü•í": { checked: false, quantity: 1 },
                "Ardel grƒÉsu»õ üå∂Ô∏è": { checked: false, quantity: 1 },
                "Morcovi ü•ï": { checked: false, quantity: 1 },
                "Usturoi üßÑ": { checked: false, quantity: 1 },
                "LƒÉm√¢i üçã": { checked: false, quantity: 1 },
                "Portocale üçä": { checked: false, quantity: 1 },
                "CeapƒÉ ro»ôie": { checked: false, quantity: 1 },
                "Struguri üçá": { checked: false, quantity: 1 },
                "Mere üçéüçè": { checked: false, quantity: 1 },
                "Porumb üåΩ": { checked: false, quantity: 1 },
                "V√¢nƒÉtƒÉ üçÜ": { checked: false, quantity: 1 },
                "VarzƒÉ ü•¨": { checked: false, quantity: 1 },
                "SalatƒÉ ü•ó": { checked: false, quantity: 1 },
                "Pepene üçâ": { checked: false, quantity: 1 },
                "Cire»ôe üçí": { checked: false, quantity: 1 },
                "Ananas üçç": { checked: false, quantity: 1 },
                "Piersici üçë": { checked: false, quantity: 1 },
                "CƒÉp»ôuni üçì": { checked: false, quantity: 1 },
                "Spanac üåø": { checked: false, quantity: 1 },
                "Afine ü´ê": { checked: false, quantity: 1 },
                "Ciuperci üçÑ": { checked: false, quantity: 1 }
            },
            "ü•õ Lactate »ôi ouƒÉ": {
                "Iaurt grecesc üßø": { checked: false, quantity: 1 },
                "Lapte ü•õ": { checked: false, quantity: 1 },
                "OuƒÉ ü•ö": { checked: false, quantity: 1 },
                "Unt üßà": { checked: false, quantity: 1 },
                "Sm√¢nt√¢nƒÉ": { checked: false, quantity: 1 },
                "Ca»ôcaval üßÄ": { checked: false, quantity: 1 },
                "Br√¢nzƒÉ rasƒÉ": { checked: false, quantity: 1 },
                "Mascarpone": { checked: false, quantity: 1 },
                "Fri»ôcƒÉ lichidƒÉ": { checked: false, quantity: 1 },
                "Kiri": { checked: false, quantity: 1 }
            },
            "ü•© Carne": {
                "GƒÉinƒÉ üêì": { checked: false, quantity: 1 },
                "Piept de pui üçó": { checked: false, quantity: 1 },
                "Carne vitƒÉ/porc ü•©": { checked: false, quantity: 1 },
                "Pulpe de pui üê£": { checked: false, quantity: 1 },
                "C√¢rna»õi": { checked: false, quantity: 1 },
                "Carne tocatƒÉ de vitƒÉ": { checked: false, quantity: 1 },
                "»òuncƒÉ ü•ì": { checked: false, quantity: 1 },
                "Ficat de pui": { checked: false, quantity: 1 }
            },
            "üè† GospodƒÉrie": {
                "RolƒÉ de h√¢rtie üßª": { checked: false, quantity: 1 },
                "Lavete": { checked: false, quantity: 1 },
                "Detergent de vase ü´ß": { checked: false, quantity: 1 },
                "SpƒÉlƒÉtor de s√¢rmƒÉ": { checked: false, quantity: 1 },
                "H√¢rtie igienicƒÉ üßª": { checked: false, quantity: 1 },
                "Bure»õi de vase": { checked: false, quantity: 1 },
                "Saci de gunoi": { checked: false, quantity: 1 },
                "Javel": { checked: false, quantity: 1 },
                "Detergent haine ü´ß": { checked: false, quantity: 1 },
                "SƒÉpun lichid üß¥": { checked: false, quantity: 1 }
            },
            "üíÜ √éngrijire personalƒÉ": {
                "Deodorant": { checked: false, quantity: 1 },
                "Gel de dus üõÄ": { checked: false, quantity: 1 },
                "PastƒÉ de din»õi ü™•": { checked: false, quantity: 1 },
                "Lame de ras ü™í": { checked: false, quantity: 1 },
                "»òampon": { checked: false, quantity: 1 },
                "Be»õi»ôoare de urechi": { checked: false, quantity: 1 }
            },
            "üíä Farmacie": {
                "Pentru g√¢t": { checked: false, quantity: 1 },
                "Leucoplast": { checked: false, quantity: 1 },
                "Decasept": { checked: false, quantity: 1 },
                "Spirt": { checked: false, quantity: 1 },
                "Ibuprofen": { checked: false, quantity: 1 },
                "Iod": { checked: false, quantity: 1 }
            },
            "ü•§ BƒÉuturi": {
                "Coca Cola ü•§": { checked: false, quantity: 1 },
                "Suc de fructe üßÉ": { checked: false, quantity: 1 },
                "ApƒÉ üíß": { checked: false, quantity: 1 },
                "Capsule cafea ‚òïÔ∏è": { checked: false, quantity: 1 },
                "Sprite": { checked: false, quantity: 1 },
                "Bere üç∫": { checked: false, quantity: 1 },
                "Vin üç∑": { checked: false, quantity: 1 }
            },
            "üçû BrutƒÉrie": {
                "Biscui»õi WASA üçò": { checked: false, quantity: 1 },
                "P√¢ine üçû": { checked: false, quantity: 1 },
                "P√¢ine feliatƒÉ ü•™": { checked: false, quantity: 1 },
                "BaghetƒÉ ü•ñ": { checked: false, quantity: 1 },
                "Lipii": { checked: false, quantity: 1 }
            },
            "üêü Pe»ôte": {
                "Somon afumat üç£": { checked: false, quantity: 1 },
                "Pe»ôte congelat üé£": { checked: false, quantity: 1 },
                "Conserve ton/somon": { checked: false, quantity: 1 },
                "Ton": { checked: false, quantity: 1 },
                "Icre": { checked: false, quantity: 1 }
            },
            "üè™ CƒÉmarƒÉ": {
                "ZahƒÉr": { checked: false, quantity: 1 },
                "O»õet": { checked: false, quantity: 1 },
                "FainƒÉ": { checked: false, quantity: 1 },
                "Pesto": { checked: false, quantity: 1 },
                "Orez üçô": { checked: false, quantity: 1 },
                "Ulei de mƒÉsline ü´í": { checked: false, quantity: 1 },
                "Paste linguine": { checked: false, quantity: 1 },
                "Nuci": { checked: false, quantity: 1 },
                "MaionezƒÉ": { checked: false, quantity: 1 },
                "PastƒÉ de tomate ü•´": { checked: false, quantity: 1 },
                "Sare üßÇ": { checked: false, quantity: 1 },
                "Ceai ü´ñ": { checked: false, quantity: 1 },
                "Ulei de floarea soarelui üåª": { checked: false, quantity: 1 },
                "Piper": { checked: false, quantity: 1 },
                "Ulei de cocos ü••": { checked: false, quantity: 1 },
                "Paste üçù": { checked: false, quantity: 1 },
                "Ro»ôii pasate": { checked: false, quantity: 1 },
                "ConservƒÉ fasole albe ü´ò": { checked: false, quantity: 1 }
            },
            "üç¨ Dulciuri": {
                "Biscui»õi": { checked: false, quantity: 1 },
                "Dulciuri üç¨": { checked: false, quantity: 1 },
                "Batoane Nakd": { checked: false, quantity: 1 },
                "CiocolatƒÉ üç´": { checked: false, quantity: 1 },
                "√énghe»õatƒÉ üçß": { checked: false, quantity: 1 },
                "Sirop Agave": { checked: false, quantity: 1 },
                "Cereale ü•£": { checked: false, quantity: 1 }
            },
            "üëï De √ÆmbrƒÉcat": {
                "»òlapi": { checked: false, quantity: 1 },
                "Hanorac": { checked: false, quantity: 1 },
                "Pulover": { checked: false, quantity: 1 },
                "Pantaloni scur»õi": { checked: false, quantity: 1 }
            },
            "üì¶ Altele": {
                "SitƒÉ/plasƒÉ chiuvetƒÉ": { checked: false, quantity: 1 },
                "Bec congelator": { checked: false, quantity: 1 },
                "H√¢rtie A4": { checked: false, quantity: 1 },
                "Markere whiteboard": { checked: false, quantity: 1 },
                "Farfurie ad√¢ncƒÉ": { checked: false, quantity: 1 }
            }
        };

        // √éncarcƒÉ lista din localStorage
        function loadShoppingList() {
            const saved = localStorage.getItem('shoppingList');
            if (saved) {
                try {
                    shoppingList = JSON.parse(saved);
                } catch (e) {
                    shoppingList = JSON.parse(JSON.stringify(defaultShoppingList));
                }
            } else {
                shoppingList = JSON.parse(JSON.stringify(defaultShoppingList));
            }
        }

        // SalveazƒÉ lista √Æn localStorage
        function saveShoppingList() {
            // SalveazƒÉ local
            localStorage.setItem('shoppingList', JSON.stringify(shoppingList));
            updateStats();
            renderShoppingList();
            restoreCategoryStates();
            
            // SincronizeazƒÉ imediat cu serverul
            syncWithServer();
        }

        // RendereazƒÉ lista de cumpƒÉrƒÉturi
        function renderShoppingList() {
            const container = document.getElementById('shoppingListContainer');
            let html = '';

            for (const [category, items] of Object.entries(shoppingList)) {
                // Sort items: unchecked first, then checked
                const sortedItems = Object.entries(items).sort((a, b) => {
                    const aChecked = typeof a[1] === 'object' ? a[1].checked : a[1];
                    const bChecked = typeof b[1] === 'object' ? b[1].checked : b[1];
                    return aChecked - bChecked; // unchecked (false=0) comes before checked (true=1)
                });

                const itemCount = Object.keys(items).length;
                const checkedCount = Object.values(items).filter(item => {
                    return typeof item === 'object' ? item.checked : item;
                }).length;
                const allChecked = checkedCount === itemCount && itemCount > 0;
                
                // SepareazƒÉ emoji din categoria
                let categoryText = category;
                let emoji = '';
                for (let i = 0; i < category.length; i++) {
                    const char = category[i];
                    const code = char.charCodeAt(0);
                    if (code > 127 || /\p{Emoji}/u.test(char)) {
                        emoji += char;
                    } else if (char === ' ') {
                        categoryText = category.substring(i + 1);
                        break;
                    } else {
                        emoji = '';
                        categoryText = category;
                        break;
                    }
                }

                html += `
                    <div class="category">
                        <div class="category-header" onclick="toggleCategory(event)">
                            <span class="toggle-icon">‚ñ∂Ô∏è</span>
                            <span class="category-name">${categoryText} ${emoji}</span>
                            <span class="category-count">${checkedCount}/${itemCount}</span>
                            <button class="check-all-btn" onclick="toggleCategoryAll(event, '${category}')">
                                ${allChecked ? '‚úì DeselecteazƒÉ' : '‚òê SelecteazƒÉ'}
                            </button>
                        </div>
                        <div class="category-items">
                            ${sortedItems.map(([product, data]) => {
                                const isChecked = typeof data === 'object' ? data.checked : data;
                                const quantity = typeof data === 'object' ? data.quantity : 1;
                                return `
                                    <div class="item">
                                        <input type="checkbox" ${isChecked ? 'checked' : ''} 
                                               onchange="toggleProduct('${category}', '${product}')">
                                        <span class="item-name">${product}</span>
                                        <div class="item-controls">
                                            <div class="quantity-controls">
                                                <button class="quantity-btn" onclick="decreaseQuantity('${category}', '${product}')">‚àí</button>
                                                <span class="quantity-display">${quantity}</span>
                                                <button class="quantity-btn" onclick="increaseQuantity('${category}', '${product}')">+</button>
                                            </div>
                                            <button class="item-delete" onclick="deleteProduct('${category}', '${product}')">»òterge</button>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        // SalveazƒÉ starea categoriilor √Æn localStorage
        function saveCategoryStates() {
            const states = {};
            document.querySelectorAll('.category-header').forEach(header => {
                const categoryName = header.querySelector('.category-name').textContent;
                states[categoryName] = header.classList.contains('collapsed');
            });
            localStorage.setItem('categoryStates', JSON.stringify(states));
        }

        // Fast save for single category toggle (no full query)
        function saveSingleCategoryState(header) {
            const states = JSON.parse(localStorage.getItem('categoryStates') || '{}');
            const categoryName = header.querySelector('.category-name').textContent;
            states[categoryName] = header.classList.contains('collapsed');
            localStorage.setItem('categoryStates', JSON.stringify(states));
        }

        // RestaureazƒÉ starea categoriilor din localStorage
        function restoreCategoryStates() {
            const states = JSON.parse(localStorage.getItem('categoryStates') || '{}');
            document.querySelectorAll('.category-header').forEach(header => {
                const categoryName = header.querySelector('.category-name').textContent;
                const isCollapsed = states[categoryName];
                if (isCollapsed) {
                    header.classList.add('collapsed');
                    header.nextElementSibling.classList.add('collapsed');
                } else {
                    header.classList.remove('collapsed');
                    header.nextElementSibling.classList.remove('collapsed');
                }
            });
        }

        // Toggle categorie
        function toggleCategory(event) {
            const header = event.currentTarget;
            header.classList.toggle('collapsed');
            const items = header.nextElementSibling;
            items.classList.toggle('collapsed');
            // Fast save - only this category
            saveSingleCategoryState(header);
        }

        // Toggle selecteazƒÉ/deselecteazƒÉ toatƒÉ categoria
        function toggleCategoryAll(event, category) {
            event.stopPropagation();
            
            // VerificƒÉ dacƒÉ toate sunt bifate
            const allChecked = Object.values(shoppingList[category]).every(item => {
                return typeof item === 'object' ? item.checked : item;
            });

            // Toggle toate
            for (const product in shoppingList[category]) {
                if (typeof shoppingList[category][product] === 'object') {
                    shoppingList[category][product].checked = !allChecked;
                } else {
                    shoppingList[category][product] = !allChecked;
                }
            }

            saveShoppingList();
        }

        // Toggle produs (bifat/nebifat)
        function toggleProduct(category, product) {
            if (typeof shoppingList[category][product] === 'object') {
                shoppingList[category][product].checked = !shoppingList[category][product].checked;
            } else {
                shoppingList[category][product] = !shoppingList[category][product];
            }
            saveShoppingList();
        }

        // Cre»ôte cantitate
        function increaseQuantity(category, product) {
            if (typeof shoppingList[category][product] === 'object') {
                if (product.toLowerCase() === "oua" || product.toLowerCase() === "ouƒÉ") { shoppingList[category][product].quantity += 5; } else { if (product.toLowerCase() === "oua" || product.toLowerCase() === "ouƒÉ") { shoppingList[category][product].quantity += 5; } else { shoppingList[category][product].quantity += 1; } }
            } else {
                shoppingList[category][product] = { checked: false, quantity: 2 };
            }
            saveShoppingList();
        }

        // Scade cantitate
        function decreaseQuantity(category, product) {
            if (typeof shoppingList[category][product] === 'object') {
                if (shoppingList[category][product].quantity > 1) {
                    shoppingList[category][product].quantity -= 1;
                    saveShoppingList();
                }
            }
        }

        let undoStack = []; // Stores recent deletions for undo
        let undoTimers = {}; // Track timeouts by deletion ID

        // »òterge produs cu undo option
        function deleteProduct(category, product) {
            const deleteId = `${Date.now()}_${Math.random()}`; // Unique ID for this deletion
            
            // Save to undo stack
            undoStack.push({
                id: deleteId,
                category,
                product,
                data: shoppingList[category][product],
                timestamp: Date.now()
            });

            // Keep only last 10 undo actions
            if (undoStack.length > 10) {
                const removed = undoStack.shift();
                clearTimeout(undoTimers[removed.id]);
                delete undoTimers[removed.id];
            }

            // Delete from list
            delete shoppingList[category][product];
            
            // Show undo popup
            showUndoPopup(category, product);
            
            // Save to server after 5 seconds (if undo not pressed)
            undoTimers[deleteId] = setTimeout(() => {
                const undoItem = undoStack.find(u => u.id === deleteId);
                if (undoItem) {
                    // Undo wasn't pressed, confirm delete
                    undoStack = undoStack.filter(u => u.id !== deleteId);
                    delete undoTimers[deleteId];
                    saveShoppingList();
                }
            }, 5000);
        }

        // Show undo popup
        function showUndoPopup(category, product) {
            const container = document.getElementById('shoppingListContainer');
            
            // Remove any existing undo popup
            const existing = document.querySelector('.undo-popup');
            if (existing) existing.remove();
            
            // Create popup
            const popup = document.createElement('div');
            popup.className = 'undo-popup';
            popup.innerHTML = `
                <div class="undo-popup-content">
                    <span>üóëÔ∏è <strong>${product}</strong> »ôters</span>
                    <button onclick="undoDelete('${category}', '${product}')">‚Ü∂ Undo</button>
                </div>
            `;
            
            container.parentElement.insertBefore(popup, container);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (popup.parentElement) {
                    popup.remove();
                }
            }, 5000);
        }

        // Undo delete
        function undoDelete(category, product) {
            const undoItem = undoStack.find(u => u.category === category && u.product === product);
            
            if (undoItem) {
                // Clear the auto-delete timeout
                if (undoTimers[undoItem.id]) {
                    clearTimeout(undoTimers[undoItem.id]);
                    delete undoTimers[undoItem.id];
                }
                
                // Restore item
                shoppingList[category][product] = undoItem.data;
                
                // Remove from undo stack
                undoStack = undoStack.filter(u => u.id !== undoItem.id);
                
                console.log(`[UNDO] Restored ${product} in ${category}`);
                
                // Save to localStorage + sync to Redis
                saveShoppingList();
                
                // Remove popup
                const popup = document.querySelector('.undo-popup');
                if (popup) popup.remove();
            }
        }

        // AdaugƒÉ produs nou
        function addProduct() {
            const category = document.getElementById('categorySelect').value;
            const productInput = document.getElementById('productInput').value.trim();

            if (!category) {
                alert('‚ö†Ô∏è SelecteazƒÉ o categorie!');
                return;
            }

            if (!productInput) {
                alert('‚ö†Ô∏è Introduce»õi un produs!');
                return;
            }

            if (shoppingList[category][productInput] !== undefined) {
                alert('‚ö†Ô∏è Acest produs existƒÉ deja √Æn lista!');
                return;
            }

            shoppingList[category][productInput] = { checked: false, quantity: 1 };
            saveShoppingList();

            document.getElementById('productInput').value = '';
            document.getElementById('productInput').focus();
        }

        // PopuleazƒÉ dropdown cu categorii
        function populateCategorySelect() {
            const select = document.getElementById('categorySelect');
            select.innerHTML = '<option value="">SelecteazƒÉ categorie...</option>';
            Object.keys(shoppingList).forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                select.appendChild(option);
            });
        }

        // ActualizeazƒÉ statistici
        function updateStats() {
            let total = 0;
            let checked = 0;

            for (const items of Object.values(shoppingList)) {
                for (const [_, data] of Object.entries(items)) {
                    total++;
                    const isChecked = typeof data === 'object' ? data.checked : data;
                    if (isChecked) checked++;
                }
            }

            document.getElementById('total-items').textContent = total;
            document.getElementById('checked-items').textContent = checked;
            document.getElementById('remaining-items').textContent = total - checked;
        }

        // Ini»õializare la √ÆncƒÉrcarea paginii
        document.addEventListener('DOMContentLoaded', async function() {
            // Generate or get sessionId
            let sessionId = localStorage.getItem('sessionId');
            if (!sessionId) {
                sessionId = 'session_' + Date.now();
                localStorage.setItem('sessionId', sessionId);
            }
            
            console.log('[INIT] SessionId:', sessionId.substring(0, 20) + '...');
            
            // Load from localStorage first
            loadShoppingList();
            
            // Then try to sync from Redis
            try {
                console.log('[INIT] Loading from Redis...');
                const response = await fetch(`/api/shopping-list?sessionId=${sessionId}`);
                if (response.ok) {
                    const serverData = await response.json();
                    if (!serverData.isNew && Object.keys(serverData.data).length > 0) {
                        console.log('[INIT] ‚úì Loaded from Redis');
                        shoppingList = serverData.data;
                        localStorage.setItem('shoppingList', JSON.stringify(shoppingList));
                        localStorage.setItem('lastSyncTime', serverData.lastUpdated);
                    } else {
                        console.log('[INIT] First time - empty Redis');
                    }
                }
            } catch (e) {
                console.log('[INIT] Could not reach Redis:', e.message);
            }
            
            // Render UI
            updateStats();
            renderShoppingList();
            restoreCategoryStates();
            
            // Setup keyboard listener
            const productInput = document.getElementById('productInput');
            if (productInput) {
                productInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        addProduct();
                    }
                });
            }
            
            // Start periodic sync (every 5 seconds)
            setInterval(pullFromServer, 5000);

            // Add Space key listener for menu generation
            document.addEventListener('keyup', function(e) {
                if (e.code === 'Space' && document.getElementById('menu-tab').style.display !== 'none') {
                    e.preventDefault();
                    generateMenu();
                }
            });
        });

        // Global helper function to clean text for PDF
        const cleanTextForPDF = (text) => {
            if (!text) return '';
            const replacements = {
                'ƒÉ': 'a', '√¢': 'a', '√Æ': 'i', '»ô': 's', '»õ': 't', 'ƒÅ': 'a',
                'ƒÇ': 'A', '√Ç': 'A', '√é': 'I', '»ò': 'S', '»ö': 'T',
                '√©': 'e', '√®': 'e', '√™': 'e', '√´': 'e', 'ƒì': 'e', 'ƒó': 'e',
                '√†': 'a', '√°': 'a', '√§': 'a', '√•': 'a', 'ƒÖ': 'a',
                '√±': 'n', '≈Ñ': 'n', '√≥': 'o', '√¥': 'o', '√∂': 'o', '√∏': 'o',
                '√π': 'u', '√∫': 'u', '√º': 'u', '≈´': 'u', '≈≥': 'u',
                '√Ω': 'y', '√ø': 'y', '≈º': 'z', '≈∫': 'z', '≈æ': 'z'
            };
            return String(text).replace(/[ƒÉ√¢√Æ»ô»õƒÅƒÇ√Ç√é»ò»ö√©√®√™√´ƒìƒó√†√°√§√•ƒÖ√±≈Ñ√≥√¥√∂√∏√π√∫√º≈´≈≥√Ω√ø≈º≈∫≈æ]/g, 
                char => replacements[char] || char);
        };

        // SchimbƒÉ tab
        function switchTab(tab) {
            // Ascunde toate taburile
            document.getElementById('menu-tab').style.display = 'none';
            document.getElementById('shopping-tab').style.display = 'none';
            document.getElementById('profile-tab').style.display = 'none';
            document.getElementById('import-tab').style.display = 'none';
            document.getElementById('analytics-tab').style.display = 'none';
            document.getElementById('calendar-tab').style.display = 'none';

            // Afi»ôeazƒÉ tabul selectat
            if (tab === 'menu') {
                document.getElementById('menu-tab').style.display = 'block';
            } else if (tab === 'shopping') {
                document.getElementById('shopping-tab').style.display = 'block';
                loadShoppingList();
                renderShoppingList();
                populateCategorySelect();
            } else if (tab === 'profile') {
                if (!currentUser) {
                    alert('Trebuie sƒÉ fii conectat pentru a accesa profilul');
                    return;
                }
                document.getElementById('profile-tab').style.display = 'block';
                updateProfilePage();
            } else if (tab === 'import') {
                document.getElementById('import-tab').style.display = 'block';
            } else if (tab === 'analytics') {
                document.getElementById('analytics-tab').style.display = 'block';
                loadAnalytics();
            } else if (tab === 'calendar') {
                document.getElementById('calendar-tab').style.display = 'block';
                renderCalendar();
            }

            // ActualizeazƒÉ tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        function searchRecipe(event, recipeName, recipeUrl) {
            event.stopPropagation();
            
            if (recipeUrl) {
                window.open(recipeUrl, '_blank');
            } else {
                const searchUrl = `https://www.ecosia.org/search?q=cum+se+face+${encodeURIComponent(recipeName)}+reteta`;
                window.open(searchUrl, '_blank');
            }
        }

        function toggleIngredients(event, dayNumber) {
            const card = event.currentTarget;
            const ingredientsContainer = card.querySelector('.ingredients-container');
            
            if (card === expandedCard) {
                ingredientsContainer.classList.remove('active');
                card.classList.remove('show-ingredients');
                expandedCard = null;
            } else {
                if (expandedCard) {
                    const prevContainer = expandedCard.querySelector('.ingredients-container');
                    prevContainer.classList.remove('active');
                    expandedCard.classList.remove('show-ingredients');
                }
                
                ingredientsContainer.classList.add('active');
                card.classList.add('show-ingredients');
                expandedCard = card;
            }
        }

        async function generateMenu() {
            const loading = document.getElementById('loading');
            const menuContainer = document.getElementById('menuContainer');
            const menuGrid = document.getElementById('menuGrid');
            const generateBtn = document.getElementById('generateBtn');

            loading.classList.add('active');
            generateBtn.disabled = true;
            menuContainer.classList.remove('active');
            expandedCard = null;

            try {
                // Fetch recipes
                const recipesResponse = await fetch('/api/recipes');
                const recipes = await recipesResponse.json();
                
                // Combine API recipes with CSV recipes
                const allRecipes = [...recipes, ...csvRecipes];
                
                recipesData = {};
                allRecipes.forEach(recipe => {
                    recipesData[recipe.Nume] = recipe.Ingrediente;
                });

                // Generate menu locally with exclusion of previous recipes
                const menu = generateLocalMenu(allRecipes);
                
                // VerificƒÉ dacƒÉ a fost o eroare din filtrare
                if (menu.error) {
                    menuGrid.innerHTML = `<p style="color: #d70015; text-align: center; padding: 40px 20px; font-size: 1.1em;">‚ö†Ô∏è ${menu.error}</p>`;
                    menuContainer.classList.add('active');
                    loading.classList.remove('active');
                    generateBtn.disabled = false;
                    return;
                }
                
                // Update previousMenuRecipes tracker & track usage
                previousMenuRecipes.clear();
                for (let day = 1; day <= 7; day++) {
                    previousMenuRecipes.add(menu[day]);
                    trackRecipeUsage(menu[day]); // Track for analytics
                }

                let menuHTML = '';
                for (let day = 1; day <= 7; day++) {
                    const recipe = menu[day] || 'N/A';
                    const isToday = day === 1;
                    const dayLabel = isToday ? 'üìÖ AZI' : `üìÖ Ziua ${day}`;
                    
                    const recipeName = typeof recipe === 'string' ? recipe : recipe.name || recipe;
                    const recipeUrl = typeof recipe === 'object' ? recipe.url : null;
                    
                    const ingredients = recipesData[recipeName] || [];
                    const ingredientsHTML = ingredients.length > 0 
                        ? `<ul class="ingredients-list">${ingredients.map(ing => `<li>${ing}</li>`).join('')}</ul>`
                        : '<p style="color: #999; font-size: 0.9em;">Nicio ingredientƒÉ disponibilƒÉ</p>';
                    
                    menuHTML += `
                        <div class="day-card ${isToday ? 'today' : ''}" onclick="toggleIngredients(event, ${day})">
                            <div class="day-number">${dayLabel}</div>
                            <div class="recipe-name" onclick="searchRecipe(event, '${recipeName}', ${recipeUrl ? `'${recipeUrl}'` : 'null'})">
                                <span>${recipeName}</span>
                                <span class="search-icon">üîç</span>
                            </div>
                            <div class="ingredients-container">
                                <div class="ingredients-title">üì¶ Ingrediente:</div>
                                ${ingredientsHTML}
                            </div>
                        </div>
                    `;
                }

                menuGrid.innerHTML = menuHTML;
                menuContainer.classList.add('active');
                document.getElementById('exportMenuBtn').style.display = 'inline-block'; // AratƒÉ butonul Export
            } catch (error) {
                console.error('Eroare:', error);
                menuGrid.innerHTML = '<p style="color: #d84315; text-align: center; padding: 20px;">‚ùå Eroare la generarea meniului. √éncearcƒÉ din nou!</p>';
                menuContainer.classList.add('active');
                document.getElementById('exportMenuBtn').style.display = 'none'; // Ascunde butonul Export
            } finally {
                loading.classList.remove('active');
                generateBtn.disabled = false;
            }
        }

        // GenereazƒÉ meniu local cu exclusion de re»õete anterioare
        // Helper: filtreazƒÉ re»õetele pe baza dietei »ôi alergiilor
        function filterRecipesByPreferences(recipes) {
            if (!currentUser) {
                return recipes; // Nu filtram dacƒÉ nu e conectat
            }

            return recipes.filter(recipe => {
                const proteinType = recipe.Proteina.toLowerCase();
                const ingredientText = (recipe.Ingrediente.join(' ') + ' ' + recipe.Nume).toLowerCase();

                // Filtrare pe dietƒÉ
                if (userPreferences.dietType === 'vegetarian') {
                    if (proteinType.includes('carne ro»ôie') || 
                        proteinType.includes('carne de pasare') || 
                        proteinType.includes('pe»ôte') ||
                        proteinType.includes('mezeluri')) {
                        return false;
                    }
                }

                if (userPreferences.dietType === 'vegan') {
                    if (proteinType.includes('carne') || 
                        proteinType.includes('pe»ôte') ||
                        proteinType.includes('mezeluri') ||
                        proteinType.includes('ouƒÉ') ||
                        ingredientText.includes('lapte') ||
                        ingredientText.includes('ouƒÉ') ||
                        ingredientText.includes('sm√¢nt√¢nƒÉ') ||
                        ingredientText.includes('br√¢nzƒÉ') ||
                        ingredientText.includes('unt')) {
                        return false;
                    }
                }

                if (userPreferences.dietType === 'keto') {
                    // Keto: exclude carbs (orez, paste, cartofi, p√¢ine, etc)
                    const highCarbIngredients = ['orez', 'paste', 'cartof', 'couscous', 'p√¢ine', 'gr√¢u', 'mazare', 'fasole', 'dovleac'];
                    if (highCarbIngredients.some(carb => ingredientText.includes(carb))) {
                        return false;
                    }
                }

                // Filtrare pe alergii
                for (const allergy of userPreferences.allergies) {
                    if (ingredientText.includes(allergy.toLowerCase())) {
                        return false;
                    }
                }

                return true;
            });
        }

        function generateLocalMenu(retete) {
            // FiltreazƒÉ re»õetele pe baza preferin»õelor utilizatorului
            const filteredRecipes = filterRecipesByPreferences(retete);

            if (filteredRecipes.length === 0) {
                return { error: 'Nu sunt re»õete disponibile pentru preferin»õele tale. √éncearcƒÉ sƒÉ schimbi dieta sau alergiile.' };
            }

            const freqLimits = {
                'carne ro»ôie': 2,
                'carne de pasare': 2,
                'pe»ôte': 2,
                'ouƒÉ': 5,
                'ouƒÉ (»ôi mezeluri)': 5,
                'mezeluri': 5,
                'legume uscate': 5,
            };

            const counters = {};
            const menu = {};
            const usedRecipes = new Set(previousMenuRecipes); // Exclude previous recipes

            for (let day = 1; day <= 7; day++) {
                // FiltreazƒÉ re»õete disponibile (exclude cele utilizate anterior)
                const available = filteredRecipes.filter(r => 
                    !usedRecipes.has(r.Nume) && canUseRecipe(r, counters, freqLimits)
                );

                if (available.length === 0) {
                    menu[day] = 'Nicio re»õetƒÉ disponibilƒÉ';
                    continue;
                }

                const recipe = available[Math.floor(Math.random() * available.length)];
                menu[day] = recipe.Nume;
                usedRecipes.add(recipe.Nume);

                const prot = recipe.Proteina.toLowerCase();
                if (prot in counters) {
                    counters[prot] += 1;
                } else {
                    counters[prot] = 1;
                }
            }

            return menu;
        }

        // Helper: check if recipe can be used based on frequency limits
        function canUseRecipe(recipe, counters, freqLimits) {
            const prot = recipe.Proteina.toLowerCase();
            if (prot in freqLimits) {
                const count = counters[prot] || 0;
                if (count >= freqLimits[prot]) {
                    return false;
                }
            }
            return true;
        }

        // Export Menu to PDF
        function exportMenuToPDF() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });

                let yPosition = 20;
                const pageHeight = doc.internal.pageSize.height;
                const margins = 20;
                const maxWidth = doc.internal.pageSize.width - (2 * margins);

                // Helper function to remove diacritics
                const cleanText = (text) => {
                    if (!text) return '';
                    const map = {
                        'ƒÉ': 'a', '√¢': 'a', '√Æ': 'i', '»ô': 's', '»õ': 't', '≈´': 'u',
                        'ƒÇ': 'A', '√Ç': 'A', '√é': 'I', '»ò': 'S', '»ö': 'T',
                        '√©': 'e', '√®': 'e', '√™': 'e', '√´': 'e', 'ƒì': 'e', 'ƒó': 'e',
                        '√†': 'a', '√°': 'a', '√§': 'a', '√•': 'a', 'ƒÖ': 'a',
                        '√±': 'n', '≈Ñ': 'n', '√≥': 'o', '√¥': 'o', '√∂': 'o', '√∏': 'o', '≈ç': 'o',
                        '√π': 'u', '√∫': 'u', '√º': 'u', '√∫': 'u', '≈≥': 'u',
                        '√Ω': 'y', '√ø': 'y', '≈º': 'z', '≈∫': 'z', '≈æ': 'z',
                        'ƒç': 'c', 'ƒá': 'c', '√ß': 'c',
                        'ƒë': 'd', '√∞': 'd', 'ƒè': 'd',
                        'ƒ£': 'g', 'ƒü': 'g',
                        'ƒ∑': 'k',
                        'ƒº': 'l', '≈Ç': 'l',
                        '≈Ñ': 'n', '≈Ü': 'n',
                        '≈ï': 'r', '≈ó': 'r', '≈ô': 'r',
                        '≈õ': 's', '≈ü': 's', '≈°': 's',
                        '≈£': 't', '≈•': 't', '≈ß': 't',
                        '≈≥': 'u', '≈Ø': 'u', '≈±': 'u',
                        '≈∫': 'z', '≈æ': 'z', '≈º': 'z'
                    };
                    return String(text).replace(/[ƒÉ√¢√Æ»ô»õ≈´ƒÇ√Ç√é»ò»ö√©√®√™√´ƒìƒó√†√°√§√•ƒÖ√±≈Ñ√≥√¥√∂√∏≈ç√π√∫√º≈≥√Ω√ø≈º≈∫≈æƒçƒá√ßƒë√∞ƒèƒ£ƒüƒ∑ƒº≈Ç≈Ñ≈Ü≈ï≈ó≈ô≈õ≈ü≈°≈£≈•≈ß≈Ø≈±≈º]/g, 
                        char => map[char] || char);
                };

                // Set to use Courier font (monospace, better for PDF compatibility)
                doc.setFont('courier');

                // Header
                doc.setFontSize(16);
                doc.setFont('courier', 'bold');
                doc.text(cleanText('MENU SAPTAMANAL'), margins, yPosition);
                yPosition += 12;

                // Date info
                doc.setFontSize(10);
                doc.setFont('courier', 'normal');
                doc.setTextColor(100, 100, 100);
                const now = new Date();
                const dateStr = 'Data: ' + now.getDate() + '.' + (now.getMonth() + 1) + '.' + now.getFullYear();
                doc.text(dateStr, margins, yPosition);
                yPosition += 8;

                // User info if logged in
                if (currentUser) {
                    doc.setFontSize(10);
                    doc.text(`Utilizator: ${cleanText(currentUser.email)}`, margins, yPosition);
                    yPosition += 5;
                    if (userPreferences.dietType !== 'balanced') {
                        const dietMap = { 'vegetarian': 'Vegetarian', 'vegan': 'Vegan', 'keto': 'Keto' };
                        doc.text(`Dieta: ${dietMap[userPreferences.dietType] || userPreferences.dietType}`, margins, yPosition);
                        yPosition += 5;
                    }
                    if (userPreferences.allergies.length > 0) {
                        doc.text(`Alergii: ${cleanText(userPreferences.allergies.join(', '))}`, margins, yPosition);
                        yPosition += 5;
                    }
                }

                yPosition += 8;
                doc.setDrawColor(200, 200, 200);
                doc.line(margins, yPosition, doc.internal.pageSize.width - margins, yPosition);
                yPosition += 10;

                // Menu items
                doc.setFontSize(11);
                doc.setTextColor(0, 0, 0);

                const menuGrid = document.getElementById('menuGrid');
                const dayCards = menuGrid.querySelectorAll('.day-card');

                dayCards.forEach((card, index) => {
                    const dayNumber = card.querySelector('.day-number').textContent;
                    const recipeName = card.querySelector('.recipe-name span').textContent;
                    const ingredientsList = card.querySelectorAll('.ingredients-list li');
                    const ingredients = Array.from(ingredientsList).map(li => li.textContent).join(', ');

                    // Check if we need a new page
                    if (yPosition > pageHeight - 60) {
                        doc.addPage();
                        yPosition = margins;
                    }

                    // Day header
                    doc.setFontSize(11);
                    doc.setFont('courier', 'bold');
                    doc.text(cleanText(dayNumber), margins, yPosition);
                    yPosition += 7;

                    // Recipe name
                    doc.setFont('courier', 'normal');
                    doc.setFontSize(10);
                    doc.setTextColor(0, 113, 227);
                    const cleanRecipeName = cleanText(recipeName);
                    const recipeLines = doc.splitTextToSize(cleanRecipeName, maxWidth - 10);
                    doc.text(recipeLines, margins + 5, yPosition);
                    yPosition += (recipeLines.length * 5) + 2;

                    // Ingredients
                    doc.setFontSize(9);
                    doc.setTextColor(100, 100, 100);
                    const cleanIngredients = cleanText(ingredients);
                    const ingredientLines = doc.splitTextToSize(cleanIngredients, maxWidth - 10);
                    doc.text(ingredientLines, margins + 5, yPosition);
                    yPosition += (ingredientLines.length * 4) + 5;

                    doc.setTextColor(0, 0, 0);
                });

                // Save PDF
                doc.save(`meniu-${new Date().toISOString().split('T')[0]}.pdf`);
            } catch (error) {
                console.error('Error exporting PDF:', error);
                alert('Eroare la export PDF. VerificƒÉ consola pentru detalii.');
            }
        }

        // Export Shopping List to PDF
        function exportShoppingListToPDF() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });

                let yPosition = 20;
                const pageHeight = doc.internal.pageSize.height;
                const margins = 20;
                const maxWidth = doc.internal.pageSize.width - (2 * margins);

                // Helper function to remove diacritics
                const cleanText = (text) => {
                    if (!text) return '';
                    const map = {
                        'ƒÉ': 'a', '√¢': 'a', '√Æ': 'i', '»ô': 's', '»õ': 't', '≈´': 'u',
                        'ƒÇ': 'A', '√Ç': 'A', '√é': 'I', '»ò': 'S', '»ö': 'T',
                        '√©': 'e', '√®': 'e', '√™': 'e', '√´': 'e', 'ƒì': 'e', 'ƒó': 'e',
                        '√†': 'a', '√°': 'a', '√§': 'a', '√•': 'a', 'ƒÖ': 'a',
                        '√±': 'n', '≈Ñ': 'n', '√≥': 'o', '√¥': 'o', '√∂': 'o', '√∏': 'o', '≈ç': 'o',
                        '√π': 'u', '√∫': 'u', '√º': 'u', '√∫': 'u', '≈≥': 'u',
                        '√Ω': 'y', '√ø': 'y', '≈º': 'z', '≈∫': 'z', '≈æ': 'z',
                        'ƒç': 'c', 'ƒá': 'c', '√ß': 'c',
                        'ƒë': 'd', '√∞': 'd', 'ƒè': 'd',
                        'ƒ£': 'g', 'ƒü': 'g',
                        'ƒ∑': 'k',
                        'ƒº': 'l', '≈Ç': 'l',
                        '≈Ñ': 'n', '≈Ü': 'n',
                        '≈ï': 'r', '≈ó': 'r', '≈ô': 'r',
                        '≈õ': 's', '≈ü': 's', '≈°': 's',
                        '≈£': 't', '≈•': 't', '≈ß': 't',
                        '≈≥': 'u', '≈Ø': 'u', '≈±': 'u',
                        '≈∫': 'z', '≈æ': 'z', '≈º': 'z'
                    };
                    return String(text).replace(/[ƒÉ√¢√Æ»ô»õ≈´ƒÇ√Ç√é»ò»ö√©√®√™√´ƒìƒó√†√°√§√•ƒÖ√±≈Ñ√≥√¥√∂√∏≈ç√π√∫√º≈≥√Ω√ø≈º≈∫≈æƒçƒá√ßƒë√∞ƒèƒ£ƒüƒ∑ƒº≈Ç≈Ñ≈Ü≈ï≈ó≈ô≈õ≈ü≈°≈£≈•≈ß≈Ø≈±≈º]/g, 
                        char => map[char] || char);
                };

                // Set to use Courier font (monospace, better for PDF compatibility)
                doc.setFont('courier');

                // Header
                doc.setFontSize(16);
                doc.setFont('courier', 'bold');
                doc.text(cleanText('LISTA DE CUMPARATURI'), margins, yPosition);
                yPosition += 12;

                // Date info
                doc.setFontSize(10);
                doc.setFont('courier', 'normal');
                doc.setTextColor(100, 100, 100);
                const now = new Date();
                const dateStr = 'Data: ' + now.getDate() + '.' + (now.getMonth() + 1) + '.' + now.getFullYear();
                doc.text(dateStr, margins, yPosition);
                yPosition += 8;

                // Statistics
                const totalItems = Object.values(shoppingList).reduce((sum, cat) => sum + Object.keys(cat).length, 0);
                const checkedItems = Object.values(shoppingList).reduce((sum, cat) => {
                    return sum + Object.values(cat).filter(item => {
                        return typeof item === 'object' ? item.checked : item;
                    }).length;
                }, 0);

                doc.setFontSize(10);
                doc.text(`Total: ${totalItems} produse | Cumparate: ${checkedItems}`, margins, yPosition);
                yPosition += 8;

                doc.setDrawColor(200, 200, 200);
                doc.line(margins, yPosition, doc.internal.pageSize.width - margins, yPosition);
                yPosition += 10;

                // Items by category
                doc.setFontSize(11);
                doc.setTextColor(0, 0, 0);

                for (const [category, items] of Object.entries(shoppingList)) {
                    // Check page break
                    if (yPosition > pageHeight - 40) {
                        doc.addPage();
                        yPosition = margins;
                    }

                    // Category header - clean text without diacritics
                    const cleanCategory = cleanText(category);
                    doc.setFontSize(11);
                    doc.setFont('courier', 'bold');
                    doc.setTextColor(0, 113, 227); // Blue
                    doc.text(cleanCategory, margins, yPosition);
                    yPosition += 8;

                    doc.setFont('courier', 'normal');
                    doc.setFontSize(10);
                    doc.setTextColor(0, 0, 0);

                    // Items
                    for (const [product, data] of Object.entries(items)) {
                        const isChecked = typeof data === 'object' ? data.checked : data;
                        const quantity = typeof data === 'object' ? data.quantity : 1;

                        if (yPosition > pageHeight - 15) {
                            doc.addPage();
                            yPosition = margins;
                        }

                        // Checkbox symbol and clean product name
                        const checkMark = isChecked ? '[X]' : '[ ]';
                        const cleanProduct = cleanText(product);
                        const textColor = isChecked ? [150, 150, 150] : [0, 0, 0];
                        doc.setTextColor(...textColor);

                        const itemText = `${checkMark} ${cleanProduct} (x${quantity})`;
                        const lines = doc.splitTextToSize(itemText, maxWidth - 10);
                        doc.text(lines, margins + 5, yPosition);
                        yPosition += (lines.length * 4) + 2;
                    }

                    yPosition += 4;
                }

                // Save PDF
                doc.save(`lista-cumparaturi-${new Date().toISOString().split('T')[0]}.pdf`);
            } catch (error) {
                console.error('Error exporting PDF:', error);
                alert('Eroare la export PDF. VerificƒÉ consola pentru detalii.');
            }
        }

        // GenereazƒÉ ID unic pentru partajare
        function generateShareLink() {
            const shareId = 'share_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            const listData = JSON.stringify(shoppingList);
            localStorage.setItem(shareId, listData);
            
            const shareUrl = window.location.origin + window.location.pathname + '?shared=' + shareId;
            
            // Copie link-ul
            navigator.clipboard.writeText(shareUrl).then(() => {
                alert('Link-ul de partajare a fost copiat √Æn clipboard:\n' + shareUrl);
            }).catch(() => {
                prompt('CopiazƒÉ link-ul de partajare:', shareUrl);
            });
        }

        // √éncarcƒÉ lista partajatƒÉ
        function loadSharedList(shareId) {
            try {
                const sharedData = localStorage.getItem(shareId);
                if (sharedData) {
                    shoppingList = JSON.parse(sharedData);
                    renderShoppingList();
                    updateStats();
                    alert('Lista partajatƒÉ a fost √ÆncƒÉrcatƒÉ cu succes!');
                }
            } catch (e) {
                console.error('Eroare la √ÆncƒÉrcarea listei partajate:', e);
            }
        }

        // SincronizeazƒÉ imediat dupƒÉ fiecare schimbare (PUSH)
        async function syncWithServer() {
            const sessionId = localStorage.getItem('sessionId') || 'local_' + Date.now();
            localStorage.setItem('sessionId', sessionId);
            const timestamp = Date.now();
            localStorage.setItem('lastSyncTime', timestamp);
            
            try {
                console.log('[SYNC UP] ‚Üí Pushing to server, sessionId:', sessionId.substring(0, 20) + '...');
                const response = await fetch('/api/shopping-list', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sessionId: sessionId,
                        data: shoppingList,
                        timestamp: timestamp
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('[SYNC UP] ‚úì Pushed to server, lastUpdated:', result.lastUpdated);
                } else {
                    console.log('[SYNC UP] ‚úó HTTP', response.status);
                }
            } catch (e) {
                console.log('[SYNC UP] ‚úó Error:', e.message);
            }
        }

        // Trage date fresh de pe server (PULL) - sincronizare multi-device
        async function pullFromServer() {
            const sessionId = localStorage.getItem('sessionId');
            if (!sessionId) {
                console.log('[PULL] ‚úó No sessionId');
                return;
            }

            try {
                console.log('[PULL] ‚Üí Fetching from server, sessionId:', sessionId.substring(0, 20) + '...');
                const url = `/api/shopping-list?sessionId=${sessionId}`;
                const response = await fetch(url);
                
                if (response.ok) {
                    const serverData = await response.json();
                    const serverTimestamp = serverData.lastUpdated || 0;
                    const localTimestamp = parseInt(localStorage.getItem('lastSyncTime')) || 0;

                    console.log('[PULL] Server timestamp:', serverTimestamp, 'Local timestamp:', localTimestamp);

                    // Daca server are versiune mai noua, actualizeaza local
                    if (serverTimestamp > localTimestamp) {
                        const oldList = JSON.stringify(shoppingList);
                        shoppingList = serverData.data;
                        const newList = JSON.stringify(shoppingList);
                        
                        // Daca s-a schimbat ceva, re-render
                        if (oldList !== newList) {
                            console.log('[SYNC DOWN] ‚úì Data updated from server!');
                            renderShoppingList();
                            updateStats();
                            restoreCategoryStates();
                        } else {
                            console.log('[PULL] Server data is same');
                        }
                    } else {
                        console.log('[PULL] Local is current');
                    }
                } else {
                    console.log('[PULL] ‚úó HTTP', response.status);
                }
            } catch (e) {
                console.log('[SYNC DOWN] ‚úó Error:', e.message);
            }
        }

        // SincronizeazƒÉ imediat dupƒÉ fiecare schimbare
        function saveShoppingListWithSync() {
            localStorage.setItem('shoppingList', JSON.stringify(shoppingList));
            updateStats();
            renderShoppingList();
            syncWithServer();  // SincronizeazƒÉ imediat!
        }

        // CALENDAR FUNCTIONS
        let currentMonth = new Date();
        let calendarPlans = JSON.parse(localStorage.getItem('calendarPlans')) || {};

        function previousMonth() {
            currentMonth.setMonth(currentMonth.getMonth() - 1);
            renderCalendar();
        }

        function nextMonth() {
            currentMonth.setMonth(currentMonth.getMonth() + 1);
            renderCalendar();
        }

        function renderCalendar() {
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            
            // SeteazƒÉ display al lunii
            const monthNames = ['Ianuarie', 'februarie', 'Martie', 'Aprilie', 'Mai', 'Iunie', 
                               'Iulie', 'August', 'Septembrie', 'Octombrie', 'Noiembrie', 'Decembrie'];
            document.getElementById('monthDisplay').textContent = monthNames[month] + ' ' + year;

            // Ob»õine prima zi a lunii »ôi numƒÉrul de zile
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            // CreazƒÉ grid-ul calendarului
            let html = '<div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin: 15px 0;">';
            const dayNames = ['Dum', 'Lun', 'Mar', 'Mie', 'Joi', 'Vin', 'S√¢m'];
            
            // Afi»ôeazƒÉ header-ul zilelor
            dayNames.forEach(day => {
                html += `<div style="text-align: center; font-weight: bold; font-size: 12px; padding: 8px; color: #666;">${day}</div>`;
            });

            // AdaugƒÉ zile goale la √Ænceput
            for (let i = 0; i < firstDay; i++) {
                html += '<div></div>';
            }

            // AdaugƒÉ zilele lunii
            const today = new Date();
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const isToday = year === today.getFullYear() && month === today.getMonth() && day === today.getDate();
                const hasPlan = calendarPlans[dateStr];
                
                let dayStyle = `padding: 10px; text-align: center; cursor: pointer; border-radius: 6px; 
                               background: ${isToday ? '#0071e3' : hasPlan ? '#e5f0ff' : '#f5f5f7'};
                               color: ${isToday ? '#fff' : '#1d1d1f'}; font-weight: ${hasPlan ? 'bold' : 'normal'};`;
                
                html += `<div style="${dayStyle}" onclick="selectDate('${dateStr}')" role="button" tabindex="0" 
                               onkeypress="if(event.key==='Enter') selectDate('${dateStr}')">${day}</div>`;
            }
            html += '</div>';

            document.getElementById('calendarView').innerHTML = html;

            // Afi»ôeazƒÉ zilele planificate
            let plannedHtml = '<div style="margin-top: 20px;">';
            const sortedDates = Object.keys(calendarPlans).sort();
            if (sortedDates.length === 0) {
                plannedHtml += '<p style="color: #666;">Nicio zi planificatƒÉ.</p>';
            } else {
                sortedDates.forEach(dateStr => {
                    const recipes = calendarPlans[dateStr];
                    plannedHtml += `<div style="padding: 10px; margin-bottom: 8px; background: #f5f5f7; border-radius: 6px;">
                                      <strong>${dateStr}</strong><br>`;
                    recipes.forEach((recipe, idx) => {
                        plannedHtml += `<div style="font-size: 13px; margin: 5px 0;">${recipe} 
                                        <span onclick="removeRecipeFromDate('${dateStr}', ${idx})" 
                                              style="color: #d70015; cursor: pointer; font-weight: bold;" 
                                              role="button" tabindex="0" aria-label="»òterge re»õetƒÉ">√ó</span></div>`;
                    });
                    plannedHtml += '</div>';
                });
            }
            plannedHtml += '</div>';
            document.getElementById('plannedDaysList').innerHTML = plannedHtml;
        }

        function selectDate(dateStr) {
            const selectedDiv = document.getElementById('selectedDateDiv');
            const existingRecipes = calendarPlans[dateStr] || [];
            
            let html = `<div style="padding: 15px; background: #fff; border-radius: 6px; margin-top: 15px;">
                        <h3 id="selectedDateTitle">${dateStr}</h3>
                        <label for="recipeSelectForDate">SelecteazƒÉ o re»õetƒÉ:</label>
                            <select id="recipeSelectForDate" aria-labelledby="selectedDateTitle" 
                                    style="margin: 10px; padding: 8px; border-radius: 4px; border: 1px solid #d5d5d7;">
                                <option value="">-- Alege --</option>`;
            
            const allRecipes = [...recipes, ...csvRecipes];
            allRecipes.forEach(recipe => {
                html += `<option value="${recipe.name}">${recipe.name}</option>`;
            });
            
            html += `</select>
                    <button onclick="assignRecipeToDate('${dateStr}')" 
                            style="padding: 8px 15px; background: #0071e3; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 10px;"
                            aria-label="AdaugƒÉ re»õetƒÉ pentru ${dateStr}">AdaugƒÉ</button>
                    <p style="font-size: 13px; color: #666;">Re»õete pentru aceastƒÉ zi: ${existingRecipes.length}</p>
                    </div>`;
            
            selectedDiv.innerHTML = html;
        }

        function assignRecipeToDate(dateStr) {
            const select = document.getElementById('recipeSelectForDate');
            const recipe = select.value;
            
            if (!recipe) {
                alert('SelecteazƒÉ o re»õetƒÉ');
                return;
            }

            if (!calendarPlans[dateStr]) {
                calendarPlans[dateStr] = [];
            }
            if (!calendarPlans[dateStr].includes(recipe)) {
                calendarPlans[dateStr].push(recipe);
            }

            localStorage.setItem('calendarPlans', JSON.stringify(calendarPlans));
            renderCalendar();
            alert('Re»õetƒÉ adƒÉugatƒÉ cu succes!');
        }

        function removeRecipeFromDate(dateStr, idx) {
            if (calendarPlans[dateStr]) {
                calendarPlans[dateStr].splice(idx, 1);
                if (calendarPlans[dateStr].length === 0) {
                    delete calendarPlans[dateStr];
                }
                localStorage.setItem('calendarPlans', JSON.stringify(calendarPlans));
                renderCalendar();
            }
        }

        function exportCalendarToPDF() {
            const sortedDates = Object.keys(calendarPlans).sort();
            if (sortedDates.length === 0) {
                alert('Nicio zi planificata pentru export');
                return;
            }

            // Helper function to remove diacritics
            const cleanText = (text) => {
                if (!text) return '';
                const map = {
                    'ƒÉ': 'a', '√¢': 'a', '√Æ': 'i', '»ô': 's', '»õ': 't', '≈´': 'u',
                    'ƒÇ': 'A', '√Ç': 'A', '√é': 'I', '»ò': 'S', '»ö': 'T',
                    '√©': 'e', '√®': 'e', '√™': 'e', '√´': 'e', 'ƒì': 'e', 'ƒó': 'e',
                    '√†': 'a', '√°': 'a', '√§': 'a', '√•': 'a', 'ƒÖ': 'a',
                    '√±': 'n', '≈Ñ': 'n', '√≥': 'o', '√¥': 'o', '√∂': 'o', '√∏': 'o', '≈ç': 'o',
                    '√π': 'u', '√∫': 'u', '√º': 'u', '√∫': 'u', '≈≥': 'u',
                    '√Ω': 'y', '√ø': 'y', '≈º': 'z', '≈∫': 'z', '≈æ': 'z',
                    'ƒç': 'c', 'ƒá': 'c', '√ß': 'c',
                    'ƒë': 'd', '√∞': 'd', 'ƒè': 'd',
                    'ƒ£': 'g', 'ƒü': 'g',
                    'ƒ∑': 'k',
                    'ƒº': 'l', '≈Ç': 'l',
                    '≈Ñ': 'n', '≈Ü': 'n',
                    '≈ï': 'r', '≈ó': 'r', '≈ô': 'r',
                    '≈õ': 's', '≈ü': 's', '≈°': 's',
                    '≈£': 't', '≈•': 't', '≈ß': 't',
                    '≈≥': 'u', '≈Ø': 'u', '≈±': 'u',
                    '≈∫': 'z', '≈æ': 'z', '≈º': 'z'
                };
                return String(text).replace(/[ƒÉ√¢√Æ»ô»õ≈´ƒÇ√Ç√é»ò»ö√©√®√™√´ƒìƒó√†√°√§√•ƒÖ√±≈Ñ√≥√¥√∂√∏≈ç√π√∫√º≈≥√Ω√ø≈º≈∫≈æƒçƒá√ßƒë√∞ƒèƒ£ƒüƒ∑ƒº≈Ç≈Ñ≈Ü≈ï≈ó≈ô≈õ≈ü≈°≈£≈•≈ß≈Ø≈±≈º]/g, 
                    char => map[char] || char);
            };

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            let yPos = 20;

            doc.setFont('courier', 'bold');
            doc.setFontSize(18);
            doc.text(cleanText('Plan Calendar'), 20, yPos);
            yPos += 15;

            doc.setFont('courier', 'normal');
            doc.setFontSize(11);
            sortedDates.forEach(dateStr => {
                if (yPos > 270) {
                    doc.addPage();
                    yPos = 20;
                }

                doc.setFontSize(12);
                doc.setFont('courier', 'bold');
                doc.setTextColor(0, 113, 227);
                doc.text(cleanText(dateStr), 20, yPos);
                yPos += 10;

                doc.setFontSize(10);
                doc.setFont('courier', 'normal');
                doc.setTextColor(29, 29, 31);
                calendarPlans[dateStr].forEach(recipe => {
                    doc.text('* ' + cleanText(recipe), 25, yPos);
                    yPos += 7;
                });

                yPos += 5;
            });

            doc.save('calendar-plan.pdf');
            alert('Calendar exportat ca PDF!');
        }

        function clearAllPlans() {
            if (confirm('E»ôti sigur cƒÉ vrei sƒÉ »ôtergi toate planurile calendarului?')) {
                calendarPlans = {};
                localStorage.removeItem('calendarPlans');
                renderCalendar();
                alert('Toate planurile au fost »ôterse');
            }
        }

        // PULL fresh data la fiecare 5 secunde (sincronizare multi-device)
        setInterval(() => {
            pullFromServer();
        }, 5000); // 5 secunde
        
        // »òi periodic PUSH, backup la 30s
        setInterval(() => {
            syncWithServer();
        }, 30000); // 30 secunde

        window.addEventListener('load', function() {
            // Ini»õializeazƒÉ lista de cumpƒÉrƒÉturi
            loadShoppingList();
            renderShoppingList();
            populateCategorySelect();
            
            // VerificƒÉ dacƒÉ avem un URL shared
            const params = new URLSearchParams(window.location.search);
            const sharedId = params.get('shared');
            if (sharedId) {
                loadSharedList(sharedId);
            }
            
            // GenereazƒÉ menu
            generateMenu();
        });
    </script>
</body>
</html>